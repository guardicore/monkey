import json

import pytest

from infection_monkey.exploit.sshexec import SSHExploiter
from infection_monkey.model.host import VictimHost
from infection_monkey.telemetry.exploit_telem import ExploitTelem
from monkey.infection_monkey.i_puppet.i_puppet import ExploiterResultData

DOMAIN_NAME = "domain-name"
IP = "0.0.0.0"
HOST = VictimHost(IP, DOMAIN_NAME)
HOST_AS_DICT = {
    "ip_addr": IP,
    "domain_name": DOMAIN_NAME,
    "os": {},
    "services": {},
    "icmp": False,
    "default_server": None,
}
EXPLOITER_NAME = "SSHExploiter"
EXPLOITER_INFO = {
    "display_name": SSHExploiter._EXPLOITED_SERVICE,
    "started": "",
    "finished": "",
    "vulnerable_urls": [],
    "vulnerable_ports": [],
    "executed_cmds": [],
}
EXPLOITER_ATTEMPTS = []
RESULT = False
OS_LINUX = "linux"
ERROR_MSG = "failed because yolo"


@pytest.fixture
def exploit_telem_test_instance():
    return ExploitTelem(
        EXPLOITER_NAME,
        HOST,
        ExploiterResultData(
            RESULT, RESULT, False, OS_LINUX, EXPLOITER_INFO, EXPLOITER_ATTEMPTS, ERROR_MSG
        ),
    )


def test_exploit_telem_send(exploit_telem_test_instance, spy_send_telemetry):
    exploit_telem_test_instance.send()
    expected_data = {
        "exploitation_result": RESULT,
        "propagation_result": RESULT,
        "interrupted": False,
        "machine": HOST_AS_DICT,
        "exploiter": EXPLOITER_NAME,
        "info": EXPLOITER_INFO,
        "attempts": EXPLOITER_ATTEMPTS,
    }
    expected_data = json.dumps(expected_data, cls=exploit_telem_test_instance.json_encoder)
    assert spy_send_telemetry.data == expected_data
    assert spy_send_telemetry.telem_category == "exploit"
