import logging
from queue import Queue
from threading import Barrier, Event
from unittest.mock import MagicMock

import pytest

from infection_monkey.master import Exploiter
from infection_monkey.model import VictimHost
from infection_monkey.puppet.mock_puppet import MockPuppet

logger = logging.getLogger()


@pytest.fixture(autouse=True)
def patch_queue_timeout(monkeypatch):
    monkeypatch.setattr("infection_monkey.master.exploiter.QUEUE_TIMEOUT", 0.001)


@pytest.fixture
def scan_completed():
    return Event()


@pytest.fixture
def stop():
    return Event()


@pytest.fixture
def callback():
    return MagicMock()


@pytest.fixture
def exploiter_config():
    return {
        "brute_force": [
            {"name": "PowerShellExploiter", "propagator": True},
            {"name": "SSHExploiter", "propagator": True},
        ],
        "vulnerability": [
            {"name": "ZerologonExploiter", "propagator": False},
        ],
    }


@pytest.fixture
def hosts():
    return [VictimHost("10.0.0.1"), VictimHost("10.0.0.3")]


@pytest.fixture
def hosts_to_exploit(hosts):
    q = Queue()
    q.put(hosts[0])
    q.put(hosts[1])

    return q


def test_exploiter(exploiter_config, callback, scan_completed, stop, hosts, hosts_to_exploit):
    # Set this so that Exploiter() exits once it has processed all victims
    scan_completed.set()

    e = Exploiter(MockPuppet(), 2)
    e.exploit_hosts(exploiter_config, hosts_to_exploit, callback, scan_completed, stop)

    assert callback.call_count == 5
    host_exploit_combos = set()

    for i in range(0, 5):
        victim_host = callback.call_args_list[i][0][0]
        exploiter_name = callback.call_args_list[i][0][1]
        host_exploit_combos.add((victim_host, exploiter_name))

    assert ("ZerologonExploiter", hosts[0]) in host_exploit_combos
    assert ("PowerShellExploiter", hosts[0]) in host_exploit_combos
    assert ("ZerologonExploiter", hosts[1]) in host_exploit_combos
    assert ("PowerShellExploiter", hosts[1]) in host_exploit_combos
    assert ("SSHExploiter", hosts[1]) in host_exploit_combos


def test_stop_after_callback(exploiter_config, callback, scan_completed, stop, hosts_to_exploit):
    callback_barrier_count = 2

    def _callback(*_):
        # Block all threads here until 2 threads reach this barrier, then set stop
        # and test that neither thread continues to scan.
        _callback.barrier.wait()
        stop.set()

    _callback.barrier = Barrier(callback_barrier_count)

    stoppable_callback = MagicMock(side_effect=_callback)

    # Intentionally NOT setting scan_completed.set(); _callback() will set stop

    e = Exploiter(MockPuppet(), callback_barrier_count + 2)
    e.exploit_hosts(exploiter_config, hosts_to_exploit, stoppable_callback, scan_completed, stop)

    assert stoppable_callback.call_count == 2
