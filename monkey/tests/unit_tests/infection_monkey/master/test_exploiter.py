import logging
from queue import Queue
from threading import Barrier, Event
from typing import Iterable
from unittest.mock import MagicMock

import pytest
from tests.unit_tests.infection_monkey.master.mock_puppet import MockPuppet

from common import OperatingSystems
from common.agent_configuration.agent_sub_configurations import (
    ExploitationConfiguration,
    PluginConfiguration,
)
from infection_monkey.master import Exploiter
from infection_monkey.model import VictimHost

logger = logging.getLogger()


@pytest.fixture(autouse=True)
def patch_queue_timeout(monkeypatch):
    monkeypatch.setattr("infection_monkey.master.exploiter.QUEUE_TIMEOUT", 0.001)


@pytest.fixture
def scan_completed():
    return Event()


@pytest.fixture
def stop():
    return Event()


@pytest.fixture
def callback():
    return MagicMock()


@pytest.fixture
def exploiter_config(default_agent_configuration):
    brute_force = [
        PluginConfiguration(name="MSSQLExploiter", options={"timeout": 10}),
        PluginConfiguration(name="SSHExploiter", options={}),
        PluginConfiguration(name="WmiExploiter", options={"timeout": 10}),
    ]
    vulnerability = [PluginConfiguration(name="ZerologonExploiter", options={})]
    return ExploitationConfiguration(
        options=default_agent_configuration.propagation.exploitation.options,
        brute_force=brute_force,
        vulnerability=vulnerability,
    )


@pytest.fixture
def hosts():
    host_1 = VictimHost("10.0.0.1")
    host_2 = VictimHost("10.0.0.3")
    return [host_1, host_2]


@pytest.fixture
def hosts_to_exploit(hosts):
    return enqueue_hosts(hosts)


def enqueue_hosts(hosts: Iterable[VictimHost]):
    q = Queue()
    for h in hosts:
        q.put(h)

    return q


def get_host_exploit_combos_from_call_args_list(call_args_list):
    host_exploit_combos = set()

    for call_args in call_args_list:
        victim_host = call_args[0][0]
        exploiter_name = call_args[0][1]
        host_exploit_combos.add((victim_host, exploiter_name))

    return host_exploit_combos


CREDENTIALS_FOR_PROPAGATION = {"usernames": ["m0nk3y", "user"], "passwords": ["1234", "pword"]}


def get_credentials_for_propagation():
    return CREDENTIALS_FOR_PROPAGATION


@pytest.fixture
def run_exploiters(exploiter_config, hosts_to_exploit, callback, scan_completed, stop):
    def inner(puppet, num_workers, hosts=hosts_to_exploit):
        # Set this so that Exploiter() exits once it has processed all victims
        scan_completed.set()

        e = Exploiter(puppet, num_workers, get_credentials_for_propagation)
        e.exploit_hosts(exploiter_config, hosts, 1, callback, scan_completed, stop)

    return inner


def test_exploiter(callback, hosts, hosts_to_exploit, run_exploiters):
    run_exploiters(MockPuppet(), 2)

    assert callback.call_count == 8
    host_exploit_combos = get_host_exploit_combos_from_call_args_list(callback.call_args_list)

    assert ("ZerologonExploiter", hosts[0]) in host_exploit_combos
    assert ("MSSQLExploiter", hosts[0]) in host_exploit_combos
    assert ("SSHExploiter", hosts[0]) in host_exploit_combos
    assert ("WmiExploiter", hosts[0]) in host_exploit_combos
    assert ("ZerologonExploiter", hosts[1]) in host_exploit_combos
    assert ("MSSQLExploiter", hosts[1]) in host_exploit_combos
    assert ("WmiExploiter", hosts[1]) in host_exploit_combos
    assert ("SSHExploiter", hosts[1]) in host_exploit_combos


def test_credentials_passed_to_exploiter(run_exploiters):
    mock_puppet = MagicMock()
    run_exploiters(mock_puppet, 1)

    for call_args in mock_puppet.exploit_host.call_args_list:
        assert call_args[0][3].get("credentials") == CREDENTIALS_FOR_PROPAGATION


def test_stop_after_callback(exploiter_config, callback, scan_completed, stop, hosts_to_exploit):
    callback_barrier_count = 2

    def _callback(*_):
        # Block all threads here until 2 threads reach this barrier, then set stop
        # and test that neither thread continues to scan.
        _callback.barrier.wait()
        stop.set()

    _callback.barrier = Barrier(callback_barrier_count)

    stoppable_callback = MagicMock(side_effect=_callback)

    # Intentionally NOT setting scan_completed.set(); _callback() will set stop

    e = Exploiter(MockPuppet(), callback_barrier_count + 2, get_credentials_for_propagation)
    e.exploit_hosts(exploiter_config, hosts_to_exploit, 1, stoppable_callback, scan_completed, stop)

    assert stoppable_callback.call_count == 2


def test_exploiter_raises_exception(callback, hosts, hosts_to_exploit, run_exploiters):
    error_message = "Unexpected error"
    mock_puppet = MockPuppet()
    mock_puppet.exploit_host = MagicMock(side_effect=Exception(error_message))
    run_exploiters(mock_puppet, 3)

    assert callback.call_count == 8

    for i in range(0, 6):
        exploit_result_data = callback.call_args_list[i][0][2]
        assert exploit_result_data.exploitation_success is False
        assert exploit_result_data.propagation_success is False
        assert error_message in exploit_result_data.error_message


def test_windows_exploiters_run_on_windows_host(callback, hosts, hosts_to_exploit, run_exploiters):
    host = VictimHost("10.0.0.1")
    host.os["type"] = OperatingSystems.WINDOWS
    q = enqueue_hosts([host])
    run_exploiters(MockPuppet(), 1, q)

    assert callback.call_count == 3
    host_exploit_combos = get_host_exploit_combos_from_call_args_list(callback.call_args_list)

    assert ("SSHExploiter", host) not in host_exploit_combos


def test_linux_exploiters_run_on_linux_host(callback, hosts, hosts_to_exploit, run_exploiters):
    host = VictimHost("10.0.0.1")
    host.os["type"] = OperatingSystems.LINUX
    q = enqueue_hosts([host])
    run_exploiters(MockPuppet(), 1, q)

    assert callback.call_count == 1
    host_exploit_combos = get_host_exploit_combos_from_call_args_list(callback.call_args_list)

    assert ("SSHExploiter", host) in host_exploit_combos


def test_all_exploiters_run_on_unknown_host(callback, hosts, hosts_to_exploit, run_exploiters):
    host = VictimHost("10.0.0.1")
    try:
        del host.os["type"]
    except KeyError:
        pass

    q = enqueue_hosts([host])
    run_exploiters(MockPuppet(), 1, q)

    assert callback.call_count == 4
    host_exploit_combos = get_host_exploit_combos_from_call_args_list(callback.call_args_list)

    assert ("ZerologonExploiter", hosts[0]) in host_exploit_combos
    assert ("MSSQLExploiter", hosts[0]) in host_exploit_combos
    assert ("SSHExploiter", host) in host_exploit_combos
    assert ("WmiExploiter", hosts[0]) in host_exploit_combos
