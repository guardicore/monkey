from ipaddress import IPv4Address
from threading import Event
from typing import List
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.smb.src.smb_exploit_client import SMBExploitClient
from agent_plugins.exploiters.smb.src.smb_exploiter import SMBExploiter
from agent_plugins.exploiters.smb.src.smb_options import SMBOptions
from tests.data_for_tests.propagation_credentials import FULL_CREDENTIALS

from common import OperatingSystem
from common.credentials import Credentials
from infection_monkey.exploit import IAgentBinaryRepository
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

CREDENTIALS: List[Credentials] = []


@pytest.fixture
def mock_exploit_client() -> SMBExploitClient:
    client = MagicMock(spec=SMBExploitClient)
    client.authenticate.return_value = True
    client.copy_file.return_value = "path"
    client.run_agent.return_value = True
    return client


@pytest.fixture
def mock_credentials_repository() -> IPropagationCredentialsRepository:
    repository = MagicMock(spec=IPropagationCredentialsRepository)
    repository.get_credentials.return_value = FULL_CREDENTIALS
    return repository


@pytest.fixture
def smb_exploiter(
    mock_exploit_client: SMBExploitClient,
    mock_credentials_repository: IPropagationCredentialsRepository,
) -> SMBExploiter:
    return SMBExploiter(
        mock_exploit_client,
        mock_credentials_repository,
        MagicMock(spec=IAgentBinaryRepository),
    )


@pytest.fixture
def target_host() -> TargetHost:
    return


def run_smb_exploiter(
    smb_exploiter: SMBExploiter, interrupt: Event = Event()
) -> ExploiterResultData:
    target_host = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.WINDOWS)
    return smb_exploiter.exploit_host(
        host=target_host,
        servers=[],
        current_depth=1,
        options=SMBOptions(),
        interrupt=interrupt,
    )


def test_exploit_host__exploit_succeeds(smb_exploiter: SMBExploiter):
    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert result.propagation_success


def test_exploit_host__exploit_fails(
    smb_exploiter: SMBExploiter, mock_exploit_client: SMBExploitClient
):
    mock_exploit_client.authenticate.return_value = False

    result = run_smb_exploiter(smb_exploiter)

    assert not result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__propagation_succeeds(
    smb_exploiter: SMBExploiter,
):
    result = run_smb_exploiter(smb_exploiter)

    assert result.exploitation_success
    assert result.propagation_success


def test_exploit_host__copy_fails(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: SMBExploitClient,
):
    mock_exploit_client.copy_file.return_value = None

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__run_agent_fails(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: SMBExploitClient,
):
    mock_exploit_client.run_agent.return_value = False

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__exploit_fails_on_authentication_error(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: SMBExploitClient,
):
    mock_exploit_client.authenticate.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert not result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__propagation_fails_on_run_agent_error(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: SMBExploitClient,
):
    mock_exploit_client.run_agent.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__exploit_skipped_on_interrupt(
    smb_exploiter: SMBExploiter, mock_exploit_client: SMBExploitClient
):
    interrupt = Event()
    interrupt.set()

    result = run_smb_exploiter(smb_exploiter, interrupt)
    assert result == ExploiterResultData()
    assert not mock_exploit_client.authenticate.called
