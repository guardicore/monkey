from io import BytesIO
from ipaddress import IPv4Address
from threading import Event
from typing import List
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.smb.src.smb_exploiter import SMBExploiter
from tests.data_for_tests.propagation_credentials import FULL_CREDENTIALS

from common import OperatingSystem
from common.credentials import Credentials
from infection_monkey.exploit import IAgentBinaryRepository
from infection_monkey.exploit.tools import IRemoteAccessClient, IRemoteAccessClientBuilder
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

CREDENTIALS: List[Credentials] = []


@pytest.fixture
def mock_exploit_client() -> IRemoteAccessClient:
    client = MagicMock(spec=IRemoteAccessClient)
    client.login.return_value = True
    client.copy_file.return_value = "path"
    client.get_available_paths.return_value = []
    client.execute.return_value = True
    return client


@pytest.fixture
def mock_exploit_client_builder(mock_exploit_client) -> IRemoteAccessClientBuilder:
    builder = MagicMock(spec=IRemoteAccessClientBuilder)
    builder.build_client.return_value = mock_exploit_client
    return builder


@pytest.fixture
def mock_credentials_repository() -> IPropagationCredentialsRepository:
    repository = MagicMock(spec=IPropagationCredentialsRepository)
    repository.get_credentials.return_value = FULL_CREDENTIALS
    return repository


@pytest.fixture
def mock_agent_binary_repository() -> IAgentBinaryRepository:
    repository = MagicMock(spec=IAgentBinaryRepository)
    repository.get_agent_binary.return_value = BytesIO(b"file")
    return repository


@pytest.fixture
def smb_exploiter(
    mock_exploit_client_builder: IRemoteAccessClientBuilder,
    mock_credentials_repository: IPropagationCredentialsRepository,
    mock_agent_binary_repository: IAgentBinaryRepository,
) -> SMBExploiter:
    return SMBExploiter(
        lambda a, b: "command",
        mock_exploit_client_builder,
        mock_credentials_repository,
        mock_agent_binary_repository,
    )


@pytest.fixture
def target_host() -> TargetHost:
    return


def run_smb_exploiter(
    smb_exploiter: SMBExploiter, interrupt: Event = Event()
) -> ExploiterResultData:
    target_host = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.WINDOWS)
    return smb_exploiter.exploit_host(
        host=target_host,
        interrupt=interrupt,
    )


def test_exploit_host__exploit_succeeds(smb_exploiter: SMBExploiter):
    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert result.propagation_success


def test_exploit_host__exploit_fails(
    smb_exploiter: SMBExploiter, mock_exploit_client: IRemoteAccessClient
):
    mock_exploit_client.login.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)

    assert not result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__propagation_succeeds(
    smb_exploiter: SMBExploiter,
):
    result = run_smb_exploiter(smb_exploiter)

    assert result.exploitation_success
    assert result.propagation_success


def test_exploit_host__copy_fails(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: IRemoteAccessClient,
):
    mock_exploit_client.copy_file.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__copy_tries_other_paths(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: IRemoteAccessClient,
):
    mock_exploit_client.copy_file.side_effect = Exception()

    def get_other_paths(*args, **kwargs):
        mock_exploit_client.copy_file.side_effect = None
        return ["other_path"]

    mock_exploit_client.get_available_paths = get_other_paths

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__execute_fails(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: IRemoteAccessClient,
):
    mock_exploit_client.execute.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__exploit_fails_on_authentication_error(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: IRemoteAccessClient,
):
    mock_exploit_client.login.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert not result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__propagation_fails_on_execute_error(
    smb_exploiter: SMBExploiter,
    mock_exploit_client: IRemoteAccessClient,
):
    mock_exploit_client.execute.side_effect = Exception()

    result = run_smb_exploiter(smb_exploiter)
    assert result.exploitation_success
    assert not result.propagation_success


def test_exploit_host__exploit_skipped_on_interrupt(
    smb_exploiter: SMBExploiter, mock_exploit_client: IRemoteAccessClient
):
    interrupt = Event()
    interrupt.set()

    result = run_smb_exploiter(smb_exploiter, interrupt)
    assert result == ExploiterResultData()
    assert not mock_exploit_client.login.called
