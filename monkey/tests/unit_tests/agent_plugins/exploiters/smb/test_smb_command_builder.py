from pathlib import PureWindowsPath
from typing import Optional
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.smb.src.smb_command_builder import build_smb_command

from common.command_builder import (
    DropperExecutionMode,
    IWindowsAgentCommandBuilder,
    WindowsRunOptions,
    WindowsShell,
)

FULL_EXE_PATH = PureWindowsPath("C:\\agent-full.exe")
DESTINATION_EXE_PATH = PureWindowsPath("C:\\agent.exe")


@pytest.fixture
def windows_agent_command_builder() -> IWindowsAgentCommandBuilder:
    return MagicMock(spec=IWindowsAgentCommandBuilder)


@pytest.fixture
def build_command(windows_agent_command_builder: IWindowsAgentCommandBuilder):
    def build(
        remote_agent_binary_full_path: PureWindowsPath,
        remote_agent_binary_destination_path: PureWindowsPath,
    ) -> str:
        return build_smb_command(
            remote_agent_binary_full_path,
            remote_agent_binary_destination_path,
            windows_agent_command_builder,
        )

    return build


@pytest.mark.parametrize(
    (
        "remote_agent_binary_full_path,remote_agent_binary_destination_path,"
        "expected_dropper_path,expected_dropper_execution_mode"
    ),
    [
        (FULL_EXE_PATH, DESTINATION_EXE_PATH, DESTINATION_EXE_PATH, DropperExecutionMode.DROPPER),
        (DESTINATION_EXE_PATH, DESTINATION_EXE_PATH, None, DropperExecutionMode.NONE),
    ],
)
def test_command(
    build_command,
    remote_agent_binary_full_path: PureWindowsPath,
    remote_agent_binary_destination_path: PureWindowsPath,
    expected_dropper_path: Optional[PureWindowsPath],
    expected_dropper_execution_mode: DropperExecutionMode,
    windows_agent_command_builder: IWindowsAgentCommandBuilder,
):
    build_command(
        remote_agent_binary_full_path,
        remote_agent_binary_destination_path,
    )

    expected_run_options = WindowsRunOptions(
        dropper_execution_mode=expected_dropper_execution_mode,
        agent_destination_path=remote_agent_binary_full_path,
        shell=WindowsShell.CMD,
        dropper_destination_path=expected_dropper_path,
    )

    windows_agent_command_builder.build_run_command.assert_called_with(expected_run_options)
    windows_agent_command_builder.get_command.assert_called_once()
