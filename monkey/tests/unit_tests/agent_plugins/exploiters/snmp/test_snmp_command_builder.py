from ipaddress import IPv4Address
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.snmp.src.snmp_command_builder import build_snmp_command
from agentpluginapi import ILinuxAgentCommandBuilder, TargetHost
from monkeytypes import OperatingSystem

EXPECTED_COMMAND = '-c "SNMP_COMMAND"'


@pytest.fixture
def linux_agent_command_builder() -> ILinuxAgentCommandBuilder:
    linux_agent_command_builder = MagicMock(spec=ILinuxAgentCommandBuilder)
    linux_agent_command_builder.get_command.return_value = "SNMP_COMMAND"
    return linux_agent_command_builder


def test_command(linux_agent_command_builder: ILinuxAgentCommandBuilder):
    actual_command = build_snmp_command(
        TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.LINUX),
        "1.1.1.1/agent",
        linux_agent_command_builder,
    )

    assert actual_command == EXPECTED_COMMAND
    assert actual_command.startswith('-c "')
    assert actual_command.endswith('"')
    linux_agent_command_builder.get_command.assert_called_once()
