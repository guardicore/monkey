from ipaddress import IPv4Address
from pathlib import PurePosixPath
from typing import Optional

import pytest
from agent_plugins.exploiters.snmp.src.snmp_command_builder import build_snmp_command
from monkeytypes import OperatingSystem

from infection_monkey.i_puppet import TargetHost

AGENT_EXE_PATH = PurePosixPath("/tmp/agent")
OTP = "123456"
TARGET_HOST = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.LINUX)
URL = "1.1.1.1/agent"


@pytest.fixture
def build_command(mock_agent_otp_environment_variable):
    def build(host: Optional[TargetHost] = None) -> str:
        return build_snmp_command(
            host or TARGET_HOST,
            URL,
            mock_agent_otp_environment_variable,
            OTP,
        )

    return build


def test_otp_used(build_command):
    command = build_command()

    assert OTP in command


def test_url_used(build_command):
    command = build_command()

    assert URL in command


def test_agent_otp_env_var_used(build_command, mock_agent_otp_environment_variable):
    command = build_command()

    assert mock_agent_otp_environment_variable in command
