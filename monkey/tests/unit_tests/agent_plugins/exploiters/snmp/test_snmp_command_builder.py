from ipaddress import IPv4Address
from pathlib import PurePosixPath
from typing import Optional

import pytest
from agent_plugins.exploiters.snmp.src.snmp_command_builder import build_snmp_command

from common import OperatingSystem
from infection_monkey.i_puppet import TargetHost
from infection_monkey.utils.ids import get_agent_id

AGENT_EXE_PATH = PurePosixPath("/tmp/agent")
OTP = "123456"
AGENT_ID = get_agent_id()
TARGET_HOST = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.LINUX)
SERVERS = ["127.0.0.1"]
DEPTH = 2
URL = "1.1.1.1/agent"


@pytest.fixture
def build_command():
    def build(host: Optional[TargetHost] = None) -> str:
        return build_snmp_command(
            AGENT_ID,
            host or TARGET_HOST,
            SERVERS,
            DEPTH,
            URL,
            OTP,
        )

    return build


def test_exception_raised_for_windows(build_command):
    with pytest.raises(Exception):
        host = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.WINDOWS)
        build_command(host=host)


def test_servers(build_command):
    command = build_command()

    for server in SERVERS:
        assert server in command


def test_otp_used(build_command):
    command = build_command()

    assert OTP in command


def test_url_used(build_command):
    command = build_command()

    assert URL in command
