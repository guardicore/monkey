from pathlib import PurePosixPath
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.ssh.src.ssh_command_builder import build_ssh_command

from common.command_builder import DropperExecutionMode, ILinuxAgentCommandBuilder, LinuxRunOptions

LINUX_AGENT_DESTINATION_PATH = PurePosixPath("C:\\agent.exe")


@pytest.fixture
def linux_agent_command_builder() -> ILinuxAgentCommandBuilder:
    return MagicMock(spec=ILinuxAgentCommandBuilder)


def test_command(linux_agent_command_builder: ILinuxAgentCommandBuilder):
    command = build_ssh_command(
        LINUX_AGENT_DESTINATION_PATH,
        linux_agent_command_builder,
    )

    expected_run_options = LinuxRunOptions(
        agent_destination_path=LINUX_AGENT_DESTINATION_PATH,
        dropper_execution_mode=DropperExecutionMode.NONE,
    )

    assert command.endswith("> /dev/null 2>&1 &")
    linux_agent_command_builder.build_run_command.assert_called_with(expected_run_options)
    linux_agent_command_builder.get_command.assert_called_once()
