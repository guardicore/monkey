from pathlib import PurePosixPath
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.ssh.src.ssh_command_builder import build_ssh_command
from agentpluginapi import ILinuxAgentCommandBuilder

LINUX_AGENT_DESTINATION_PATH = PurePosixPath("C:\\agent.exe")
EXPECTED_COMMAND = "SSH_COMMAND > /dev/null 2>&1 &"


@pytest.fixture
def linux_agent_command_builder() -> ILinuxAgentCommandBuilder:
    linux_agent_command_builder = MagicMock(spec=ILinuxAgentCommandBuilder)
    linux_agent_command_builder.get_command.return_value = "SSH_COMMAND"
    return linux_agent_command_builder


def test_command(linux_agent_command_builder: ILinuxAgentCommandBuilder):
    actual_command = build_ssh_command(
        LINUX_AGENT_DESTINATION_PATH,
        linux_agent_command_builder,
    )

    assert actual_command == EXPECTED_COMMAND
    assert actual_command.endswith("> /dev/null 2>&1 &")
    linux_agent_command_builder.get_command.assert_called_once()
