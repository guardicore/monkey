from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.wmi.src.wmi_client import WMIClient
from monkeytypes import Credentials, OperatingSystem, Password, Username

from infection_monkey.i_puppet import TargetHost

TARGET_HOST = TargetHost(ip="1.1.1.1", operating_system=OperatingSystem.WINDOWS)
CREDENTIALS = Credentials(
    identity=Username(username="m0nk3y"), secret=Password(password="password")
)


@pytest.fixture
def mock_dcom_connection(monkeypatch):
    dcom = MagicMock()
    monkeypatch.setattr(
        "agent_plugins.exploiters.wmi.src.wmi_client.DCOMConnection",
        MagicMock(return_value=dcom),
    )
    return dcom


@pytest.fixture
def mock_wbem_login(monkeypatch):
    wbem_login = MagicMock()
    monkeypatch.setattr(
        "impacket.dcerpc.v5.dcom.wmi.IWbemLevel1Login",
        MagicMock(return_value=wbem_login),
    )
    return wbem_login


@pytest.fixture
def mock_dcom_firewall_checker(monkeypatch):
    monkeypatch.setattr(
        "agent_plugins.exploiters.wmi.src.wmi_client.check_dcom_connection", MagicMock()
    )


def test_login__raises_on_dcom_error(mock_dcom_connection, mock_wbem_login):
    mock_dcom_connection.CoCreateInstanceEx.side_effect = Exception
    wmi_client = WMIClient()

    with pytest.raises(Exception):
        wmi_client.login(TARGET_HOST, CREDENTIALS)
    assert mock_dcom_connection.CoCreateInstanceEx.called


def test_login__raises_on_wbem_error(
    mock_dcom_connection, mock_wbem_login, monkeypatch, mock_dcom_firewall_checker
):
    mock_wbem_login.NTLMLogin.side_effect = Exception

    wmi_client = WMIClient()

    with pytest.raises(Exception):
        wmi_client.login(TARGET_HOST, CREDENTIALS)
    assert mock_wbem_login.NTLMLogin.called


def test_login__success(mock_dcom_connection, mock_wbem_login, mock_dcom_firewall_checker):
    wmi_client = WMIClient()

    wmi_client.login(TARGET_HOST, CREDENTIALS)


def test_login__fail_when_victim_unaccessable(mock_dcom_connection, mock_wbem_login):
    wmi_client = WMIClient()

    with pytest.raises(Exception):
        wmi_client.login(TARGET_HOST, CREDENTIALS)
