import pytest
from agent_plugins.exploiters.wmi.src.wmi_options import WMIOptions

UPLOAD_TIMEOUT = 12.4
CONNECT_TIMEOUT = 11.9

WMI_OPTIONS_DICT = {
    "agent_binary_upload_timeout": UPLOAD_TIMEOUT,
    "smb_connect_timeout": CONNECT_TIMEOUT,
}

WMI_OPTIONS_OBJECT = WMIOptions(
    agent_binary_upload_timeout=UPLOAD_TIMEOUT,
    smb_connect_timeout=CONNECT_TIMEOUT,
)

UPLOAD_TIMEOUT_EXCEPTION = {"agent_binary_upload_timeout": 70000, "smb_connect_timeout": 15.0}
CONNECT_TIMEOUT_EXCEPTION = {"agent_binary_upload_timeout": 30.0, "smb_connect_timeout": 70000}


def test_wmi_options__serialization():
    assert WMI_OPTIONS_OBJECT.to_json_dict() == WMI_OPTIONS_DICT


def test_wmi_options__full_serialization():
    assert WMIOptions(**WMI_OPTIONS_OBJECT.to_json_dict()) == WMI_OPTIONS_OBJECT


def test_wmi_options__deserialization():
    assert WMIOptions(**WMI_OPTIONS_DICT) == WMI_OPTIONS_OBJECT


def test_wmi_options__default():
    wmi_options = WMIOptions()

    assert wmi_options.agent_binary_upload_timeout == 30.0


@pytest.mark.parametrize("options_dict", [UPLOAD_TIMEOUT_EXCEPTION, CONNECT_TIMEOUT_EXCEPTION])
def test_wmi_options_constrains(options_dict):
    with pytest.raises(ValueError):
        WMIOptions(**options_dict)
