import pytest
from agent_plugins.exploiters.wmi.src.smb_options import SMBOptions

UPLOAD_TIMEOUT = 12.4
SMB_CONNECT_TIMEOUT = 42.1


SMB_OPTIONS_DICT = {
    "agent_binary_upload_timeout": UPLOAD_TIMEOUT,
    "smb_connect_timeout": SMB_CONNECT_TIMEOUT,
}


SMB_OPTIONS_OBJECT = SMBOptions(
    agent_binary_upload_timeout=UPLOAD_TIMEOUT,
    smb_connect_timeout=SMB_CONNECT_TIMEOUT,
)

UPLOAD_TIMEOUT_EXCEPTION = {"agent_binary_upload_timeout": 70000}
SMB_TIMEOUT_EXCEPTION = {"smb_connect_timeout": 101}


def test_smb_options__serialization():
    assert SMB_OPTIONS_OBJECT.model_dump(mode="json") == SMB_OPTIONS_DICT


def test_smb_options__full_serialization():
    assert SMBOptions(**SMB_OPTIONS_OBJECT.model_dump(mode="json")) == SMB_OPTIONS_OBJECT


def test_smb_options__deserialization():
    assert SMBOptions(**SMB_OPTIONS_DICT) == SMB_OPTIONS_OBJECT


def test_smb_options__default():
    smb_options = SMBOptions()

    assert smb_options.agent_binary_upload_timeout == 30.0
    assert smb_options.smb_connect_timeout == 15.0


@pytest.mark.parametrize(
    "options_dict",
    [
        UPLOAD_TIMEOUT_EXCEPTION,
        SMB_TIMEOUT_EXCEPTION,
    ],
)
def test_smb_options_constrains(options_dict):
    with pytest.raises(ValueError):
        SMBOptions(**options_dict)
