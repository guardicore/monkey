from ipaddress import IPv4Address
from threading import Event
from unittest.mock import MagicMock
from uuid import UUID

import pytest
from agent_plugins.exploiters.mssql.src.mssql_exploiter import MSSQLExploiter
from agent_plugins.exploiters.mssql.src.plugin import Plugin
from monkeytypes import OperatingSystem

from common.types import NetworkPort, NetworkService, PortStatus
from infection_monkey.i_puppet import (
    ExploiterResult,
    PortScanData,
    PortScanDataDict,
    TargetHost,
    TargetHostPorts,
)
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

AGENT_ID = UUID("5c145d4e-ec61-44f7-998e-17477112f50f")
BAD_MSSQL_OPTIONS_DICT = {"blah": "blah"}
TARGET_IP = IPv4Address("1.1.1.1")
MSSQL_PORTS = [NetworkPort(1433), NetworkPort(1434)]
OPEN_MSSQL_PORTS = TargetHostPorts(
    tcp_ports=PortScanDataDict(
        {
            MSSQL_PORTS[0]: PortScanData(
                port=MSSQL_PORTS[0], status=PortStatus.OPEN, service=NetworkService.MSSQL
            ),
            MSSQL_PORTS[1]: PortScanData(
                port=MSSQL_PORTS[1], status=PortStatus.OPEN, service=NetworkService.UNKNOWN
            ),
        }
    )
)
EMPTY_TARGET_HOST_PORTS = TargetHostPorts()
SERVERS = ["10.10.10.10"]
EXPLOITER_RESULT = ExploiterResult(True, False, error_message="Test error")


@pytest.fixture
def target_host() -> TargetHost:
    return TargetHost(
        ip=TARGET_IP,
        operating_system=OperatingSystem.WINDOWS,
        ports_status=OPEN_MSSQL_PORTS,
    )


@pytest.fixture
def propagation_credentials_repository():
    return MagicMock(spec=IPropagationCredentialsRepository)


class ErrorRaisingMockMSSQLExploiter(MSSQLExploiter):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def exploit_host(self, *args, **kwargs) -> ExploiterResult:
        raise Exception("Test error")


@pytest.fixture
def mock_mssql_exploiter():
    exploiter = MagicMock()
    exploiter.exploit_host.return_value = EXPLOITER_RESULT
    return exploiter


@pytest.fixture
def plugin(
    monkeypatch,
    propagation_credentials_repository: IPropagationCredentialsRepository,
    mock_mssql_exploiter,
    agent_otp_environment_variable,
) -> Plugin:
    monkeypatch.setattr(
        "agent_plugins.exploiters.mssql.src.plugin.MSSQLExploiter",
        lambda *args, **kwargs: mock_mssql_exploiter,
    )

    return Plugin(
        plugin_name="MSSQL",
        agent_id=AGENT_ID,
        http_agent_binary_server_registrar=MagicMock(),
        agent_event_publisher=MagicMock(),
        agent_binary_repository=MagicMock(),
        propagation_credentials_repository=propagation_credentials_repository,
        tcp_port_selector=MagicMock(),
        otp_provider=MagicMock(),
        agent_otp_environment_variable=agent_otp_environment_variable,
    )


def test_run__fails_on_bad_options(plugin: Plugin, target_host: TargetHost):
    result = plugin.run(
        host=target_host,
        servers=SERVERS,
        current_depth=1,
        options=BAD_MSSQL_OPTIONS_DICT,
        interrupt=Event(),
    )

    assert not result.exploitation_success
    assert not result.propagation_success


@pytest.mark.parametrize(
    "tcp_port_status",
    (
        PortScanDataDict(
            {MSSQL_PORTS[0]: PortScanData(port=MSSQL_PORTS[0], status=PortStatus.CLOSED)}
        ),
        PortScanDataDict(
            {MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.CLOSED)}
        ),
        PortScanDataDict({}),
    ),
)
def test_run__attempts_exploit_if_port_status_unknown(
    plugin: Plugin,
    mock_mssql_exploiter,
    target_host: TargetHost,
    tcp_port_status: PortScanDataDict,
):
    host = target_host.model_copy(deep=True)
    host.ports_status.tcp_ports = tcp_port_status
    result = plugin.run(
        host=host,
        servers=SERVERS,
        current_depth=1,
        options={"target_ports": MSSQL_PORTS},
        interrupt=Event(),
    )

    mock_mssql_exploiter.exploit_host.assert_called_once()
    assert result == EXPLOITER_RESULT


@pytest.mark.parametrize(
    "tcp_port_status",
    (
        PortScanDataDict(
            {
                MSSQL_PORTS[0]: PortScanData(
                    port=MSSQL_PORTS[0], status=PortStatus.OPEN, service=NetworkService.MSSQL
                )
            }
        ),
        PortScanDataDict(
            {MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.OPEN)}
        ),
        PortScanDataDict(
            {
                MSSQL_PORTS[0]: PortScanData(
                    port=MSSQL_PORTS[0], status=PortStatus.CLOSED, service=NetworkService.MSSQL
                ),
                MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.OPEN),
            }
        ),
        PortScanDataDict(
            {
                MSSQL_PORTS[0]: PortScanData(
                    port=MSSQL_PORTS[0], status=PortStatus.OPEN, service=NetworkService.MSSQL
                ),
                MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.CLOSED),
            }
        ),
        PortScanDataDict(
            {
                MSSQL_PORTS[0]: PortScanData(
                    port=MSSQL_PORTS[0], status=PortStatus.OPEN, service=NetworkService.MSSQL
                ),
                MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.OPEN),
            }
        ),
    ),
)
def test_run__attempts_exploit_if_port_status_open(
    plugin: Plugin,
    mock_mssql_exploiter,
    target_host: TargetHost,
    tcp_port_status: PortScanDataDict,
):
    host = target_host.model_copy(deep=True)
    host.ports_status.tcp_ports = tcp_port_status
    result = plugin.run(
        host=host,
        servers=SERVERS,
        current_depth=1,
        options={"target_ports": MSSQL_PORTS},
        interrupt=Event(),
    )

    mock_mssql_exploiter.exploit_host.assert_called_once()
    assert result == EXPLOITER_RESULT


def test_run__skips_exploit_if_port_status_closed(
    plugin: Plugin,
    mock_mssql_exploiter,
    target_host: TargetHost,
):
    host = target_host.model_copy(deep=True)
    host.ports_status.tcp_ports = PortScanDataDict(
        {
            MSSQL_PORTS[0]: PortScanData(
                port=MSSQL_PORTS[0], status=PortStatus.CLOSED, service=NetworkService.MSSQL
            ),
            MSSQL_PORTS[1]: PortScanData(port=MSSQL_PORTS[1], status=PortStatus.CLOSED),
        }
    )

    result = plugin.run(
        host=host,
        servers=SERVERS,
        current_depth=1,
        options={
            "target_ports": MSSQL_PORTS,
        },
        interrupt=Event(),
    )

    mock_mssql_exploiter.exploit_host.assert_not_called()
    assert result.exploitation_success is False
    assert result.propagation_success is False


def test_run__if_discovered_mssql_unknown_ports(
    plugin: Plugin,
    mock_mssql_exploiter,
    target_host: TargetHost,
):
    host = target_host.model_copy(deep=True)
    host.ports_status.tcp_ports = PortScanDataDict(
        {
            MSSQL_PORTS[0]: PortScanData(
                port=MSSQL_PORTS[0], status=PortStatus.OPEN, service=NetworkService.MSSQL
            ),
            NetworkPort(1234): PortScanData(port=NetworkPort(1234), status=PortStatus.OPEN),
            NetworkPort(1235): PortScanData(port=NetworkPort(1235), status=PortStatus.CLOSED),
        }
    )

    result = plugin.run(
        host=host,
        servers=SERVERS,
        current_depth=1,
        options={
            "target_ports": MSSQL_PORTS,
            "try_discovered_mssql_ports": True,
            "try_unknown_service_ports": True,
        },
        interrupt=Event(),
    )

    mock_mssql_exploiter.exploit_host.assert_called_once()
    assert result == EXPLOITER_RESULT


def test_run__returns_exploiter_result(plugin: Plugin, target_host: TargetHost):
    result = plugin.run(
        host=target_host,
        servers=SERVERS,
        current_depth=1,
        options={},
        interrupt=Event(),
    )

    assert result == EXPLOITER_RESULT


def test_run__exploit_host_raises_exception(
    monkeypatch,
    plugin: Plugin,
    propagation_credentials_repository: IPropagationCredentialsRepository,
    target_host: TargetHost,
    agent_otp_environment_variable,
):
    monkeypatch.setattr(
        "agent_plugins.exploiters.mssql.src.plugin.MSSQLExploiter",
        ErrorRaisingMockMSSQLExploiter,
    )

    plugin = Plugin(
        plugin_name="MSSQL",
        agent_id=AGENT_ID,
        http_agent_binary_server_registrar=MagicMock(),
        agent_event_publisher=MagicMock(),
        agent_binary_repository=MagicMock(),
        propagation_credentials_repository=propagation_credentials_repository,
        tcp_port_selector=MagicMock(),
        otp_provider=MagicMock(),
        agent_otp_environment_variable=agent_otp_environment_variable,
    )
    result = plugin.run(
        host=target_host,
        servers=SERVERS,
        current_depth=1,
        options={},
        interrupt=Event(),
    )

    assert not result.exploitation_success
    assert not result.propagation_success
