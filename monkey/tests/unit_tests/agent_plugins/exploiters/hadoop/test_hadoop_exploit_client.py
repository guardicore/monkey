import json
from ipaddress import IPv4Address
from threading import Event
from typing import Callable, Optional, Tuple
from unittest.mock import MagicMock
from uuid import UUID

import pytest
import requests
import requests_mock
from agent_plugins.exploiters.hadoop.src.hadoop_exploit_client import HadoopExploitClient
from agent_plugins.exploiters.hadoop.src.hadoop_options import HadoopOptions

from common import OperatingSystem
from common.agent_events import ExploitationEvent, PropagationEvent
from common.event_queue import IAgentEventPublisher
from infection_monkey.model import TargetHost
from infection_monkey.transport import LockedHTTPServer

SERVERS = ["1.1.1.2, 1.1.1.3"]
FAKE_AGENT_ID = UUID("9614480d-471b-4568-86b5-cb922a34ed8a")
FAKE_APPLICATION_ID = "application_1404198295326_0003"
FAKE_NEW_APPLICATION_RESPONSE_DICT = {
    "application-id": FAKE_APPLICATION_ID,
    "maximum-resource-capability": {"memory": 8192, "vCores": 32},
}

TARGET = "http://www.localhost"
NEW_APP_PATH = "/ws/v1/cluster/apps/new-application"
SUBMIT_APP_PATH = "/ws/v1/cluster/apps/"
NEW_APP_URL = f"{TARGET}{NEW_APP_PATH}"
SUBMIT_APP_URL = f"{TARGET}{SUBMIT_APP_PATH}"
URLS_TO_EXPLOIT = ["http://testurl1", "http://testurl2"]
NEW_APP_URL_1 = f"{URLS_TO_EXPLOIT[0]}{NEW_APP_PATH}"
SUBMIT_APP_URL_1 = f"{URLS_TO_EXPLOIT[0]}{SUBMIT_APP_PATH}"
NEW_APP_URL_2 = f"{URLS_TO_EXPLOIT[1]}{NEW_APP_PATH}"
SUBMIT_APP_URL_2 = f"{URLS_TO_EXPLOIT[1]}{SUBMIT_APP_PATH}"
COMMAND = "echo test"


@pytest.fixture
def mock_hadoop_server():
    with requests_mock.Mocker() as m:
        m.post(
            NEW_APP_URL,
            json=FAKE_NEW_APPLICATION_RESPONSE_DICT,
        )
        m.post(SUBMIT_APP_URL, json="", status_code=202)
        m.post(
            NEW_APP_URL_1,
            json=FAKE_NEW_APPLICATION_RESPONSE_DICT,
        )
        m.post(SUBMIT_APP_URL_1, json="", status_code=202)
        m.post(
            NEW_APP_URL_2,
            json=FAKE_NEW_APPLICATION_RESPONSE_DICT,
        )
        m.post(SUBMIT_APP_URL_2, json="", status_code=202)
        yield m


@pytest.fixture
def mock_agent_event_publisher() -> IAgentEventPublisher:
    return MagicMock(spec=IAgentEventPublisher)


@pytest.fixture(params=[OperatingSystem.WINDOWS, OperatingSystem.LINUX])
def target_host(request) -> TargetHost:
    return TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=request.param)


@pytest.fixture
def interrupt() -> Event:
    return Event()


@pytest.fixture
def hadoop_exploiter_client(
    request,
    mock_agent_event_publisher: IAgentEventPublisher,
) -> HadoopExploitClient:
    return HadoopExploitClient(
        FAKE_AGENT_ID,
        mock_agent_event_publisher,
    )


@pytest.fixture
def exploit(
    target_host, interrupt, hadoop_exploiter_client
) -> Callable[[], Tuple[bool, bool]]:
    def _inner() -> Tuple[bool, bool]:
        return hadoop_exploiter_client.exploit(
            target_host, HadoopOptions(), interrupt, TARGET, COMMAND
        )

    return _inner


def test_exploit__new_application_request(
    mock_hadoop_server, exploit: Callable[[], Tuple[bool, bool]]
):
    exploit()

    assert mock_hadoop_server.called
    assert mock_hadoop_server.request_history[0].url == NEW_APP_URL


def test_exploit__payload(
    mock_hadoop_server, exploit: Callable[[], Tuple[bool, bool]], monkeypatch
):
    monkeypatch.setattr(
        "agent_plugins.exploiters.hadoop.src.hadoop_exploit_client.insecure_generate_random_string",
        MagicMock(return_value="random"),
    )

    exploit()

    assert mock_hadoop_server.call_count == 2
    assert mock_hadoop_server.request_history[1].url == SUBMIT_APP_URL
    payload = mock_hadoop_server.last_request.json()
    assert payload["application-id"] == FAKE_APPLICATION_ID
    assert payload["application-name"] == f"{HadoopOptions().yarn_application_suffix}random"
    assert payload["am-container-spec"]["commands"]["command"] == COMMAND
    assert payload["application-type"] == "YARN"


def test_exploit__success(mock_hadoop_server, exploit: Callable[[], Tuple[bool, bool]]):
    exploitation_success, _ = exploit()
    assert exploitation_success


@pytest.mark.parametrize("status_code", [200, 404, 500])
def test_exploit__failure_if_bad_hadoop_response(
    mock_hadoop_server, exploit: Callable[[], Tuple[bool, bool]], status_code: int
):
    mock_hadoop_server.post(SUBMIT_APP_URL, json="", status_code=status_code)
    exploitation_success, _ = exploit()
    assert not exploitation_success


def _assert_published_events(agent_event_publisher: MagicMock, success: bool):
    published_events = agent_event_publisher.publish.call_args_list
    published_events = [param[0][0] for param in published_events]

    assert ExploitationEvent in [type(event) for event in published_events]
    assert PropagationEvent in [type(event) for event in published_events]
    assert all([event.success == success for event in published_events])


def test_exploit__failure_if_request_timeout(
    mock_hadoop_server,
    exploit: Callable[[], Tuple[bool, bool]],
    mock_agent_event_publisher: MagicMock,
):
    mock_hadoop_server.post(NEW_APP_URL, exc=requests.ConnectionError)
    exploitation_success, _ = exploit()
    assert not exploitation_success
    assert mock_hadoop_server.call_count == 1
    _assert_published_events(mock_agent_event_publisher, success=False)


def test_exploit__sends_events_on_success(
    mock_hadoop_server,
    exploit: Callable[[], Tuple[bool, bool]],
    mock_agent_event_publisher: MagicMock,
):
    exploit()

    _assert_published_events(mock_agent_event_publisher, success=True)


def test_exploit__sends_events_on_failure(
    mock_hadoop_server,
    exploit: Callable[[], Tuple[bool, bool]],
    mock_agent_event_publisher: MagicMock,
):
    mock_hadoop_server.post(SUBMIT_APP_URL, json="", status_code=500)
    exploit()

    _assert_published_events(mock_agent_event_publisher, success=False)


def test_exploit__interrupt_between_requests(
    mock_hadoop_server,
    exploit: Callable[[], Tuple[bool, bool]],
    mock_agent_event_publisher: MagicMock,
    interrupt: Event,
):
    def interrupt_callback(request, context):
        interrupt.set()
        return json.dumps({"application-id": FAKE_NEW_APPLICATION_RESPONSE_DICT})

    mock_hadoop_server.post(NEW_APP_URL, text=interrupt_callback)

    exploitation_success, _ = exploit()

    assert not exploitation_success
    history = mock_hadoop_server.request_history
    assert len(history) == 1
    assert NEW_APP_URL in str(history[0])
    assert not mock_agent_event_publisher.called


def create_none_agent_binary_server(
    host, agent_binary_repository
) -> Tuple[Optional[str], Optional[LockedHTTPServer]]:
    return None, None


def create_agent_binary_server(
    host, agent_binary_repository
) -> Tuple[Optional[str], Optional[LockedHTTPServer]]:
    return "url", MagicMock()
