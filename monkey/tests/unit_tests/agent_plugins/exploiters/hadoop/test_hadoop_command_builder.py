from ipaddress import IPv4Address

import pytest
from agent_plugins.exploiters.hadoop.src.hadoop_command_builder import build_hadoop_command
from agentpluginapi import TargetHost
from monkeytypes import OperatingSystem

from infection_monkey.model import MONKEY_ARG
from infection_monkey.utils.ids import get_agent_id

AGENT_ID = get_agent_id()
SERVERS = ["192.168.1.100", "172.1.2.3"]
DEPTH = 2
AGENT_DESTINATION_PATH = "/tmp"
AGENT_DOWNLOAD_URL = "http://download.here"
OTP = "123456"


@pytest.fixture
def build_command(agent_otp_environment_variable):
    def build(host: TargetHost) -> str:
        return build_hadoop_command(
            AGENT_ID,
            host,
            SERVERS,
            DEPTH,
            AGENT_DESTINATION_PATH,
            AGENT_DOWNLOAD_URL,
            agent_otp_environment_variable,
            OTP,
        )

    return build


def test_command__linux(build_command):
    command = build_command(
        host=TargetHost(ip=IPv4Address("127.0.0.1"), operating_system=OperatingSystem.LINUX)
    )

    assert "wget" in command
    assert str(AGENT_DOWNLOAD_URL) in command
    assert MONKEY_ARG in command
    assert str(AGENT_ID) in command
    assert all([server in command for server in SERVERS])
    assert str(DEPTH + 1) in command
    assert OTP in command


@pytest.mark.parametrize("os", [OperatingSystem.WINDOWS, None])
def test_command__windows(build_command, os):
    command = build_command(host=TargetHost(ip=IPv4Address("127.0.0.1"), operating_system=os))

    assert "powershell" in command
    assert str(AGENT_DOWNLOAD_URL) in command
    assert MONKEY_ARG in command
    assert str(AGENT_ID) in command
    assert all([server in command for server in SERVERS])
    assert str(DEPTH + 1) in command
    assert OTP in command
