from ipaddress import IPv4Address
from threading import Event
from unittest.mock import MagicMock
from uuid import UUID

import pytest
from agent_plugins.exploiters.hadoop.src.hadoop_exploiter import HadoopExploiter
from agent_plugins.exploiters.hadoop.src.plugin import Plugin
from monkeytypes import OperatingSystem

from infection_monkey.i_puppet import ExploiterResult, TargetHost

AGENT_ID = UUID("5c145d4e-ec61-44f7-998e-17477112f50f")
BAD_HADOOP_OPTIONS_DICT = {"blah": "blah"}
TARGET_IP = IPv4Address("1.1.1.1")
TARGET_HOST = TargetHost(ip=TARGET_IP, operating_system=OperatingSystem.WINDOWS)
SERVERS = ["10.10.10.10"]
EXPLOITER_RESULT = ExploiterResult(True, False, error_message="Test error")


class MockHadoopExploiter(HadoopExploiter):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def exploit_host(self, *args, **kwargs) -> ExploiterResult:
        return EXPLOITER_RESULT


class ErrorRaisingMockHadoopExploiter(HadoopExploiter):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

    def exploit_host(self, *args, **kwargs) -> ExploiterResult:
        raise Exception("Test error")


@pytest.fixture
def plugin(monkeypatch, mock_agent_otp_environment_variable) -> Plugin:
    monkeypatch.setattr(
        "agent_plugins.exploiters.hadoop.src.plugin.HadoopExploiter", MockHadoopExploiter
    )

    return Plugin(
        plugin_name="Hadoop",
        agent_id=AGENT_ID,
        http_agent_binary_server_registrar=MagicMock(),
        agent_event_publisher=MagicMock(),
        otp_provider=MagicMock(),
        agent_otp_environment_variable=mock_agent_otp_environment_variable,
    )


def test_run__fails_on_bad_options(plugin: Plugin):
    result = plugin.run(
        host=TARGET_HOST,
        servers=SERVERS,
        current_depth=1,
        options=BAD_HADOOP_OPTIONS_DICT,
        interrupt=Event(),
    )

    assert not result.exploitation_success
    assert not result.propagation_success


def test_run__returns_exploiter_result(plugin: Plugin):
    result = plugin.run(
        host=TARGET_HOST,
        servers=SERVERS,
        current_depth=1,
        options={},
        interrupt=Event(),
    )

    assert result == EXPLOITER_RESULT


def test_run__exploit_host_raises_exception(
    monkeypatch, plugin: Plugin, mock_agent_otp_environment_variable
):
    monkeypatch.setattr(
        "agent_plugins.exploiters.hadoop.src.plugin.HadoopExploiter",
        ErrorRaisingMockHadoopExploiter,
    )

    plugin = Plugin(
        plugin_name="Hadoop",
        agent_id=AGENT_ID,
        http_agent_binary_server_registrar=MagicMock(),
        agent_event_publisher=MagicMock(),
        otp_provider=MagicMock(),
        agent_otp_environment_variable=mock_agent_otp_environment_variable,
    )
    result = plugin.run(
        host=TARGET_HOST,
        servers=SERVERS,
        current_depth=1,
        options={},
        interrupt=Event(),
    )

    assert not result.exploitation_success
    assert not result.propagation_success
