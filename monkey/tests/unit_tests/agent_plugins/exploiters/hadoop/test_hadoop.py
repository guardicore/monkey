import json
from ipaddress import IPv4Address
from threading import Event
from unittest.mock import MagicMock
from uuid import UUID

import pytest
import requests
import requests_mock
from agent_plugins.exploiters.hadoop.src.hadoop import Hadoop, HadoopOptions

from common import OperatingSystem
from common.agent_events import ExploitationEvent, PropagationEvent
from common.event_queue import IAgentEventPublisher
from infection_monkey.model import TargetHost

FAKE_AGENT_ID = UUID("9614480d-471b-4568-86b5-cb922a34ed8a")
FAKE_APPLICATION_ID = "application_1404198295326_0003"
FAKE_NEW_APPLICATION_RESPONSE_DICT = {
    "application-id": FAKE_APPLICATION_ID,
    "maximum-resource-capability": {"memory": 8192, "vCores": 32},
}

TARGET = "http://www.localhost"
NEW_APP_URL = f"{TARGET}/ws/v1/cluster/apps/new-application"
SUBMIT_APP_URL = f"{TARGET}/ws/v1/cluster/apps/"
COMMAND = "echo test"


@pytest.fixture
def mock_hadoop_server():
    with requests_mock.Mocker() as m:
        m.post(
            NEW_APP_URL,
            json=FAKE_NEW_APPLICATION_RESPONSE_DICT,
        )
        m.post(SUBMIT_APP_URL, json="", status_code=202)
        yield m


@pytest.fixture
def mock_agent_event_publisher() -> IAgentEventPublisher:
    return MagicMock(spec=IAgentEventPublisher)


@pytest.fixture
def interrupt():
    return Event()


@pytest.fixture
def mock_hadoop_exploiter(
    mock_agent_event_publisher: IAgentEventPublisher, interrupt: Event
) -> Hadoop:
    target_host = TargetHost(ip=IPv4Address("1.1.1.1"), operating_system=OperatingSystem.WINDOWS)
    return Hadoop(
        target_host, HadoopOptions(), interrupt, FAKE_AGENT_ID, mock_agent_event_publisher
    )


def test_exploit__new_application_request(mock_hadoop_server, mock_hadoop_exploiter: Hadoop):
    mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    assert mock_hadoop_server.called
    assert mock_hadoop_server.request_history[0].url == NEW_APP_URL


def test_exploit__payload(mock_hadoop_server, mock_hadoop_exploiter: Hadoop, monkeypatch):
    monkeypatch.setattr(
        "agent_plugins.exploiters.hadoop.src.hadoop.insecure_generate_random_string",
        MagicMock(return_value="random"),
    )

    mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    assert mock_hadoop_server.call_count == 2
    assert mock_hadoop_server.request_history[1].url == SUBMIT_APP_URL
    payload = mock_hadoop_server.last_request.json()
    assert payload["application-id"] == FAKE_APPLICATION_ID
    assert payload["application-name"] == f"{HadoopOptions().yarn_application_suffix}random"
    assert payload["am-container-spec"]["commands"]["command"] == COMMAND
    assert payload["application-type"] == "YARN"


def test_exploit__success(mock_hadoop_server, mock_hadoop_exploiter: Hadoop):
    assert mock_hadoop_exploiter.exploit(TARGET, COMMAND)


@pytest.mark.parametrize("status_code", [200, 404, 500])
def test_exploit__failure_if_bad_hadoop_response(
    mock_hadoop_server, mock_hadoop_exploiter: Hadoop, status_code: int
):
    mock_hadoop_server.post(SUBMIT_APP_URL, json="", status_code=status_code)
    assert not mock_hadoop_exploiter.exploit(TARGET, COMMAND)


def _assert_published_events(agent_event_publisher: MagicMock, success: bool):
    published_events = agent_event_publisher.publish.call_args_list
    published_events = [param[0][0] for param in published_events]

    assert ExploitationEvent in [type(event) for event in published_events]
    assert PropagationEvent in [type(event) for event in published_events]
    assert all([event.success == success for event in published_events])


def test_exploit__failure_if_request_timeout(
    mock_hadoop_server, mock_hadoop_exploiter: Hadoop, mock_agent_event_publisher: MagicMock
):
    mock_hadoop_server.post(NEW_APP_URL, exc=requests.ConnectionError)
    assert not mock_hadoop_exploiter.exploit(TARGET, COMMAND)
    assert mock_hadoop_server.call_count == 1
    _assert_published_events(mock_agent_event_publisher, success=False)


def test_exploit__sends_events_on_success(
    mock_hadoop_server, mock_hadoop_exploiter: Hadoop, mock_agent_event_publisher: MagicMock
):
    mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    _assert_published_events(mock_agent_event_publisher, success=True)


def test_exploit__sends_events_on_failure(
    mock_hadoop_server, mock_hadoop_exploiter: Hadoop, mock_agent_event_publisher: MagicMock
):
    mock_hadoop_server.post(SUBMIT_APP_URL, json="", status_code=500)
    mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    _assert_published_events(mock_agent_event_publisher, success=False)


def test_exploit__first_interrupt(
    mock_hadoop_server,
    mock_hadoop_exploiter: Hadoop,
    mock_agent_event_publisher: MagicMock,
    interrupt: Event,
):
    interrupt.set()

    result = mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    assert not result
    assert not mock_hadoop_server.called
    assert not mock_agent_event_publisher.called


def test_exploit__second_interrupt(
    mock_hadoop_server,
    mock_hadoop_exploiter: Hadoop,
    mock_agent_event_publisher: MagicMock,
    interrupt: Event,
):
    def interrupt_callback(request, context):
        interrupt.set()
        return json.dumps({"application-id": FAKE_NEW_APPLICATION_RESPONSE_DICT})

    mock_hadoop_server.post(NEW_APP_URL, text=interrupt_callback)

    result = mock_hadoop_exploiter.exploit(TARGET, COMMAND)

    assert not result
    history = mock_hadoop_server.request_history
    assert len(history) == 1
    assert NEW_APP_URL in str(history[0])
    assert not mock_agent_event_publisher.called
