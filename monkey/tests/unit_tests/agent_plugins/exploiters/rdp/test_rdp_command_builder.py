from pathlib import PureWindowsPath
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.rdp.src.rdp_command_builder import build_rdp_command

from common.command_builder import (
    DropperExecutionMode,
    IWindowsAgentCommandBuilder,
    WindowsRunOptions,
    WindowsShell,
)

AGENT_DESTINATION_EXE_PATH = PureWindowsPath("C:\\agent.exe")


@pytest.fixture
def windows_agent_command_builder() -> IWindowsAgentCommandBuilder:
    return MagicMock(spec=IWindowsAgentCommandBuilder)


def test_command(windows_agent_command_builder: IWindowsAgentCommandBuilder):
    build_rdp_command(AGENT_DESTINATION_EXE_PATH, windows_agent_command_builder)

    expected_run_options = WindowsRunOptions(
        dropper_execution_mode=DropperExecutionMode.DROPPER,
        agent_destination_path=AGENT_DESTINATION_EXE_PATH,
        shell=WindowsShell.CMD,
    )
    windows_agent_command_builder.build_run_command.assert_called_with(expected_run_options)
    windows_agent_command_builder.get_command.assert_called_once()
