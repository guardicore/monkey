from pathlib import PureWindowsPath
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.rdp.src.rdp_command_builder import build_rdp_command
from agentpluginapi import IWindowsAgentCommandBuilder

AGENT_DESTINATION_PATH = PureWindowsPath("C:\\dropper.exe")
EXPECTED_COMMAND = "POWERSHELL_RUN_AGENT_COMMAND"


@pytest.fixture
def windows_agent_command_builder() -> IWindowsAgentCommandBuilder:
    mock_command_builder = MagicMock(spec=IWindowsAgentCommandBuilder)
    mock_command_builder.get_command.return_value = EXPECTED_COMMAND
    return mock_command_builder


def test_build_rdp_command(windows_agent_command_builder: IWindowsAgentCommandBuilder):
    actual_command = build_rdp_command(
        AGENT_DESTINATION_PATH,
        windows_agent_command_builder,
    )

    windows_agent_command_builder.get_command.assert_called_once()
    assert actual_command == EXPECTED_COMMAND
