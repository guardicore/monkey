from copy import copy
from typing import Sequence, Set, Type

from agent_plugins.exploiters.rdp.src.rdp_credentials_generator import generate_rdp_credentials
from tests.data_for_tests.propagation_credentials import CREDENTIALS, PASSWORD_1

from common.credentials import Credentials, LMHash, NTHash, Password, Secret, Username

TEST_CREDENTIALS = copy(CREDENTIALS)
SECRET_TYPES: Set[Type[Secret]] = {Password, LMHash, NTHash}
DOMAINS: Sequence[str] = ["TEST_DOMAIN_1", "TEST_DOMAIN_2"]


def assert_correct_identity_types(credentials: Sequence[Credentials]):
    for c in credentials:
        assert isinstance(c.identity, Username) or c.identity is None


def assert_correct_secret_types(credentials: Sequence[Credentials]):
    for c in credentials:
        assert type(c.secret) in SECRET_TYPES or c.secret is None


def assert_domain_users_added(credentials: Sequence[Credentials], domains: Sequence[str]):
    for c in credentials:
        if c.identity is None:
            continue

        if "\\" in c.identity.username:
            continue

        for domain in domains:
            assert (
                Credentials(
                    identity=Username(username=f"{domain}\\{c.identity.username}"),
                    secret=c.secret,
                )
                in credentials
            )


def test_brute_force_credentials_generation():
    generated_credentials = generate_rdp_credentials(TEST_CREDENTIALS, DOMAINS)

    assert_correct_identity_types(generated_credentials)
    assert_correct_secret_types(generated_credentials)
    assert_domain_users_added(generated_credentials, DOMAINS)
    assert len(generated_credentials) == 20


def test_brute_force_credentials_generation__no_domains():
    generated_credentials = generate_rdp_credentials(TEST_CREDENTIALS, [])

    assert len(generated_credentials) == 0


def test_usernames_with_domain():
    input_credentials = [
        Credentials(
            identity=Username(username="domain\\testuser"), secret=Password(password=PASSWORD_1)
        )
    ]
    generated_credentials = generate_rdp_credentials(input_credentials, [])

    assert len(generated_credentials) == 1
