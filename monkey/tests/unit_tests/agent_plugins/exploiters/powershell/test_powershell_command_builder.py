from pathlib import PureWindowsPath

from agent_plugins.exploiters.powershell.src.powershell_command_builder import (
    build_powershell_command,
)

from infection_monkey.model import DROPPER_ARG
from infection_monkey.utils.ids import get_agent_id

DROPPER_EXE_PATH = PureWindowsPath("C:\\dropper.exe")
OTP = "123456"
AGENT_ID = get_agent_id()


def test_servers():
    servers = ["127.0.0.1", "192.168.1.100", "172.1.2.3"]
    command = build_powershell_command(
        AGENT_ID,
        servers,
        2,
        DROPPER_EXE_PATH,
    )

    for s in servers:
        assert s in command


def test_dropper_used():
    command = build_powershell_command(
        AGENT_ID,
        ["127.0.0.1"],
        2,
        DROPPER_EXE_PATH,
    )

    assert DROPPER_ARG in command


def test_otp_used():
    command = build_powershell_command(
        AGENT_ID,
        ["127.0.0.1"],
        2,
        DROPPER_EXE_PATH,
    )

    assert OTP in command
