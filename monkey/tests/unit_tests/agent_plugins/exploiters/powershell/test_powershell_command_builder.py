from pathlib import PureWindowsPath
from unittest.mock import MagicMock

import pytest
from agent_plugins.exploiters.powershell.src.powershell_command_builder import (
    build_powershell_command,
)
from agentpluginapi import IWindowsAgentCommandBuilder

DROPPER_DESTINATION_PATH = PureWindowsPath("C:\\dropper.exe")
EXPECTED_COMMAND = "cmd.exe /c POWERSHELL_RUN_AGENT_COMMAND"


@pytest.fixture
def windows_agent_command_builder() -> IWindowsAgentCommandBuilder:
    mock_command_builder = MagicMock(spec=IWindowsAgentCommandBuilder)
    mock_command_builder.get_command.return_value = "POWERSHELL_RUN_AGENT_COMMAND"
    return mock_command_builder


def test_build_powershell_command(windows_agent_command_builder: IWindowsAgentCommandBuilder):
    actual_command = build_powershell_command(
        DROPPER_DESTINATION_PATH,
        windows_agent_command_builder,
    )

    windows_agent_command_builder.get_command.assert_called_once()
    assert actual_command.startswith("cmd.exe /c")
    assert actual_command == EXPECTED_COMMAND
