from agent_plugins.exploiters.powershell.src.powershell_auth_options import (
    AUTH_BASIC,
    AUTH_NEGOTIATE,
    AUTH_NTLM,
    ENCRYPTION_AUTO,
    ENCRYPTION_NEVER,
    get_auth_options,
)

from common.credentials import Credentials, LMHash, NTHash, Password, Username

CREDENTIALS_WITH_PASSWORD = Credentials(
    identity=Username(username="user1"), secret=Password(password="password1")
)
CREDENTIALS_EMPTY_PASSWORD = Credentials(
    identity=Username(username="user2"), secret=Password(password="")
)
CREDENTIALS_NONE_PASSWORD = Credentials(identity=Username(username="user3"), secret=None)
CREDENTIALS_LM_HASH = Credentials(
    identity=Username(username="user4"), secret=LMHash(lm_hash="c080132b6f2a0c4e5d1029cc06f48a92")
)
CREDENTIALS_NT_HASH = Credentials(
    identity=Username(username="user5"), secret=NTHash(nt_hash="E9F85516721DDC218359AD5280DB4450")
)


def test_get_auth_options__ssl_false_with_no_open_ports(powershell_disabled_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, powershell_disabled_host)
    assert auth_options.ssl is False


def test_get_auth_options__ssl_true_with_password(https_only_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, https_only_host)

    assert auth_options.ssl


def test_get_auth_options__ssl_preferred(http_and_https_both_enabled_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, http_and_https_both_enabled_host)

    assert auth_options.ssl


def test_get_auth_options__ssl_true_empty_password(https_only_host):
    auth_options = get_auth_options(CREDENTIALS_EMPTY_PASSWORD, https_only_host)

    assert not auth_options.ssl


def test_get_auth_options__ssl_true_none_password(https_only_host):
    auth_options = get_auth_options(CREDENTIALS_NONE_PASSWORD, https_only_host)

    assert auth_options.ssl


def test_get_auth_options__ssl_false_with_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, http_only_host)

    assert not auth_options.ssl


def test_get_auth_options__ssl_false_empty_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_EMPTY_PASSWORD, http_only_host)

    assert not auth_options.ssl


def test_get_auth_options__ssl_false_none_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_NONE_PASSWORD, http_only_host)

    assert not auth_options.ssl


def test_get_auth_options__auth_type_with_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, http_only_host)

    assert auth_options.auth_type == AUTH_NEGOTIATE


def test_get_auth_options__auth_type_empty_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_EMPTY_PASSWORD, http_only_host)

    assert auth_options.auth_type == AUTH_BASIC


def test_get_auth_options__auth_type_none_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_NONE_PASSWORD, http_only_host)

    assert auth_options.auth_type == AUTH_NEGOTIATE


def test_get_auth_options__auth_type_with_LM_hash(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_LM_HASH, http_only_host)

    assert auth_options.auth_type == AUTH_NTLM


def test_get_auth_options__auth_type_with_NT_hash(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_NT_HASH, http_only_host)

    assert auth_options.auth_type == AUTH_NTLM


def test_get_auth_options__encryption_with_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_WITH_PASSWORD, http_only_host)

    assert auth_options.encryption == ENCRYPTION_AUTO


def test_get_auth_options__encryption_empty_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_EMPTY_PASSWORD, http_only_host)

    assert auth_options.encryption == ENCRYPTION_NEVER


def test_get_auth_options__encryption_none_password(http_only_host):
    auth_options = get_auth_options(CREDENTIALS_NONE_PASSWORD, http_only_host)

    assert auth_options.encryption == ENCRYPTION_AUTO
