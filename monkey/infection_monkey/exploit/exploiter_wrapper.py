import threading
from typing import Dict, Sequence, Type

from common.event_queue import IAgentEventQueue
from infection_monkey.model import TargetHost

from . import IAgentBinaryRepository
from .HostExploiter import HostExploiter


class ExploiterWrapper:
    """
    This class is a temporary measure to allow existing exploiters to play nicely within the
    confines of the IPuppet interface. It keeps a reference to an IAgentEventQueue that is passed
    to all exploiters. Additionally, it constructs a new instance of the exploiter for each call to
    exploit_host(). When exploiters are refactored into plugins, this class will likely go away.
    """

    class Inner:
        def __init__(
            self,
            exploit_class: Type[HostExploiter],
            event_queue: IAgentEventQueue,
            agent_binary_repository: IAgentBinaryRepository,
        ):
            self._exploit_class = exploit_class
            self._event_queue = event_queue
            self._agent_binary_repository = agent_binary_repository

        def exploit_host(
            self,
            host: TargetHost,
            servers: Sequence[str],
            current_depth: int,
            options: Dict,
            interrupt: threading.Event,
        ):
            exploiter = self._exploit_class()
            return exploiter.exploit_host(
                host,
                servers,
                current_depth,
                self._event_queue,
                self._agent_binary_repository,
                options,
                interrupt,
            )

    def __init__(
        self,
        event_queue: IAgentEventQueue,
        agent_binary_repository: IAgentBinaryRepository,
    ):
        self._event_queue = event_queue
        self._agent_binary_repository = agent_binary_repository

    def wrap(self, exploit_class: Type[HostExploiter]):
        return ExploiterWrapper.Inner(
            exploit_class,
            self._event_queue,
            self._agent_binary_repository,
        )
