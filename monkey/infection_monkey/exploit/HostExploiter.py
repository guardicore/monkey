import logging
from abc import abstractmethod
from datetime import datetime
from time import time
from typing import Dict, Sequence, Tuple

from common.agent_events import ExploitationEvent, PropagationEvent
from common.event_queue import IAgentEventQueue
from common.types import Event
from common.utils.exceptions import FailedExploitationError
from infection_monkey.i_puppet import ExploiterResultData
from infection_monkey.model import TargetHost
from infection_monkey.network.info import TCPPortSelector
from infection_monkey.utils.ids import get_agent_id

from . import IAgentBinaryRepository

logger = logging.getLogger(__name__)


class HostExploiter:
    @property
    @abstractmethod
    def _EXPLOITED_SERVICE(self):
        pass

    @property
    @abstractmethod
    def _EXPLOITER_TAGS(self) -> Tuple[str, ...]:
        pass

    @property
    @abstractmethod
    def _PROPAGATION_TAGS(self) -> Tuple[str, ...]:
        pass

    def __init__(self):
        self.exploit_info = {
            "display_name": self._EXPLOITED_SERVICE,
            "started": "",
            "finished": "",
            "vulnerable_urls": [],
            "vulnerable_ports": [],
            "executed_cmds": [],
        }
        self.exploit_attempts = []
        self.host = None
        self.agent_event_queue = None
        self.options = {}
        self.exploit_result = {}
        self.servers = []

    def set_start_time(self):
        self.exploit_info["started"] = datetime.now().isoformat()

    def set_finish_time(self):
        self.exploit_info["finished"] = datetime.now().isoformat()

    def report_login_attempt(self, result, user, password="", lm_hash="", ntlm_hash="", ssh_key=""):
        self.exploit_attempts.append(
            {
                "result": result,
                "user": user,
                "password": password,
                "lm_hash": lm_hash,
                "ntlm_hash": ntlm_hash,
                "ssh_key": ssh_key,
            }
        )

    def exploit_host(
        self,
        host: TargetHost,
        servers: Sequence[str],
        current_depth: int,
        agent_event_queue: IAgentEventQueue,
        agent_binary_repository: IAgentBinaryRepository,
        tcp_port_selector: TCPPortSelector,
        options: Dict,
        interrupt: Event,
    ):
        self.host = host
        self.servers = servers
        self.current_depth = current_depth
        self.agent_event_queue = agent_event_queue
        self.agent_binary_repository = agent_binary_repository
        self.tcp_port_selector = tcp_port_selector
        self.options = options
        self.interrupt = interrupt

        self.pre_exploit()
        try:
            return self._exploit_host()
        except FailedExploitationError as e:
            logger.debug(f"Exploiter failed: {e}.")
            raise e
        except Exception as e:
            logger.error("Exception in exploit_host", exc_info=True)
            raise e
        finally:
            self.post_exploit()

    def pre_exploit(self):
        self.exploit_result = ExploiterResultData(
            os=self.host.operating_system, info=self.exploit_info
        )
        self.set_start_time()

    def _is_interrupted(self):
        return self.interrupt.is_set()

    def post_exploit(self):
        self.set_finish_time()

    @abstractmethod
    def _exploit_host(self):
        raise NotImplementedError()

    def add_vuln_url(self, url):
        self.exploit_info["vulnerable_urls"].append(url)

    def add_vuln_port(self, port):
        self.exploit_info["vulnerable_ports"].append(port)

    def add_executed_cmd(self, cmd):
        """
        Appends command to exploiter's info.
        :param cmd: String of executed command. e.g. 'echo Example'
        """
        powershell = True if "powershell" in cmd.lower() else False
        self.exploit_info["executed_cmds"].append({"cmd": cmd, "powershell": powershell})

    def _publish_exploitation_event(
        self,
        time: float = time(),
        success: bool = False,
        tags: Tuple[str, ...] = tuple(),
        error_message: str = "",
    ):
        exploitation_event = ExploitationEvent(
            source=get_agent_id(),
            target=self.host.ip,
            success=success,
            exploiter_name=self.__class__.__name__,
            error_message=error_message,
            timestamp=time,
            tags=frozenset(tags or self._EXPLOITER_TAGS),
        )
        self.agent_event_queue.publish(exploitation_event)

    def _publish_propagation_event(
        self,
        time: float = time(),
        success: bool = False,
        tags: Tuple[str, ...] = tuple(),
        error_message: str = "",
    ):
        propagation_event = PropagationEvent(
            source=get_agent_id(),
            target=self.host.ip,
            success=success,
            exploiter_name=self.__class__.__name__,
            error_message=error_message,
            timestamp=time,
            tags=frozenset(tags or self._PROPAGATION_TAGS),
        )
        self.agent_event_queue.publish(propagation_event)
