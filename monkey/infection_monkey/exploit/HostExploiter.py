import logging
import threading
from abc import abstractmethod
from datetime import datetime
from ipaddress import IPv4Address
from typing import Dict, Sequence

from common.agent_events import ExploitationEvent, PropagationEvent
from common.event_queue import IAgentEventQueue
from common.utils.exceptions import FailedExploitationError
from infection_monkey.i_puppet import ExploiterResultData
from infection_monkey.model import VictimHost
from infection_monkey.telemetry.messengers.i_telemetry_messenger import ITelemetryMessenger
from infection_monkey.utils.ids import get_agent_id

from . import IAgentBinaryRepository

logger = logging.getLogger(__name__)


class HostExploiter:
    @property
    @abstractmethod
    def _EXPLOITED_SERVICE(self):
        pass

    def __init__(self):
        self.exploit_info = {
            "display_name": self._EXPLOITED_SERVICE,
            "started": "",
            "finished": "",
            "vulnerable_urls": [],
            "vulnerable_ports": [],
            "executed_cmds": [],
        }
        self.exploit_attempts = []
        self.host = None
        self.telemetry_messenger = None
        self.agent_event_queue = None
        self.options = {}
        self.exploit_result = {}
        self.servers = []

    def set_start_time(self):
        self.exploit_info["started"] = datetime.now().isoformat()

    def set_finish_time(self):
        self.exploit_info["finished"] = datetime.now().isoformat()

    def report_login_attempt(self, result, user, password="", lm_hash="", ntlm_hash="", ssh_key=""):
        self.exploit_attempts.append(
            {
                "result": result,
                "user": user,
                "password": password,
                "lm_hash": lm_hash,
                "ntlm_hash": ntlm_hash,
                "ssh_key": ssh_key,
            }
        )

    def exploit_host(
        self,
        host: VictimHost,
        servers: Sequence[str],
        current_depth: int,
        telemetry_messenger: ITelemetryMessenger,
        agent_event_queue: IAgentEventQueue,
        agent_binary_repository: IAgentBinaryRepository,
        options: Dict,
        interrupt: threading.Event,
    ):
        self.host = host
        self.servers = servers
        self.current_depth = current_depth
        self.telemetry_messenger = telemetry_messenger
        self.agent_event_queue = agent_event_queue
        self.agent_binary_repository = agent_binary_repository
        self.options = options
        self.interrupt = interrupt

        self.pre_exploit()
        try:
            return self._exploit_host()
        except FailedExploitationError as e:
            logger.debug(f"Exploiter failed: {e}.")
            raise e
        except Exception as e:
            logger.error("Exception in exploit_host", exc_info=True)
            raise e
        finally:
            self.post_exploit()

    def pre_exploit(self):
        self.exploit_result = ExploiterResultData(
            os=self.host.os.get("type"), info=self.exploit_info, attempts=self.exploit_attempts
        )
        self.set_start_time()

    def _is_interrupted(self):
        return self.interrupt.is_set()

    def _set_interrupted(self):
        # This method should be refactored to raise an exception to reduce duplication in the
        # "if is_interrupted: return self.exploitation_results"
        # Ideally the user should only do "check_for_interrupt()"
        logger.info("Exploiter has been interrupted")
        self.exploit_result.interrupted = True

    def post_exploit(self):
        self.set_finish_time()

    @abstractmethod
    def _exploit_host(self):
        raise NotImplementedError()

    def add_vuln_url(self, url):
        self.exploit_info["vulnerable_urls"].append(url)

    def add_vuln_port(self, port):
        self.exploit_info["vulnerable_ports"].append(port)

    def add_executed_cmd(self, cmd):
        """
        Appends command to exploiter's info.
        :param cmd: String of executed command. e.g. 'echo Example'
        """
        powershell = True if "powershell" in cmd.lower() else False
        self.exploit_info["executed_cmds"].append({"cmd": cmd, "powershell": powershell})

    def publish_propagation_event(
        self,
        target: str,
        propagation_success: bool,
        tags: frozenset = frozenset(),
        error_message: str = "",
    ):
        propagation_event = PropagationEvent(
            source=get_agent_id(),
            target=IPv4Address(target),
            success=propagation_success,
            exploiter_name=self.__class__.__name__,
            error_message=error_message,
            tags=tags,
        )
        self.agent_event_queue.publish(propagation_event)

    def publish_exploitation_event(
        self,
        target: str,
        exploitation_success: bool,
        tags: frozenset = frozenset(),
        error_message: str = "",
    ):
        exploitation_event = ExploitationEvent(
            source=get_agent_id(),
            target=IPv4Address(target),
            success=exploitation_success,
            exploiter_name=self.__class__.__name__,
            error_message=error_message,
            tags=tags,
        )
        self.agent_event_queue.publish(exploitation_event)
