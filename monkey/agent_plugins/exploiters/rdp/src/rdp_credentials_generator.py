from typing import Iterable, Sequence

from common.credentials import Credentials, LMHash, NTHash, Password, Username
from infection_monkey.exploit.tools import (
    generate_brute_force_credentials,
    identity_type_filter,
    secret_type_filter,
)


def generate_rdp_credentials(
    credentials: Sequence[Credentials], domains: Sequence[str]
) -> Sequence[Credentials]:
    brute_force_credentials = generate_brute_force_credentials(
        credentials,
        identity_filter=identity_type_filter([Username]),
        secret_filter=secret_type_filter([Password, LMHash, NTHash]),
    )
    rdp_credentials = list(_add_domains_to_usernames(brute_force_credentials, domains))

    return _remove_duplicate_credentials(rdp_credentials)


def _add_domains_to_usernames(
    credentials: Sequence[Credentials], domains: Sequence[str]
) -> Iterable[Credentials]:
    for credential in credentials:
        if credential.identity is None:
            continue

        if "\\" in credential.identity.username:
            yield credential

        for domain in domains:
            yield Credentials(
                identity=Username(username=f"{domain}\\{credential.identity.username}"),
                secret=credential.secret,
            )


def _remove_duplicate_credentials(credentials: Sequence[Credentials]) -> Sequence[Credentials]:
    # Using a dict, not a set, to preserve order
    credentials_dict = dict.fromkeys(credentials, None)

    return list(credentials_dict.keys())
