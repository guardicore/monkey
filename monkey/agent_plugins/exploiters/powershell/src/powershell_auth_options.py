from dataclasses import dataclass

from common.credentials import Credentials, LMHash, NTHash, Password, get_plaintext
from common.types import NetworkPort, PortStatus
from infection_monkey.i_puppet import TargetHost

AUTH_BASIC = "basic"
AUTH_NEGOTIATE = "negotiate"
AUTH_NTLM = "ntlm"
ENCRYPTION_AUTO = "auto"
ENCRYPTION_NEVER = "never"

POWERSHELL_SSL_PORT = NetworkPort(5986)


@dataclass
class AuthOptions:
    auth_type: str
    encryption: str
    ssl: bool


def get_auth_options(credentials: Credentials, host: TargetHost) -> AuthOptions:
    ssl = _get_ssl(credentials, host)
    auth_type = _get_auth_type(credentials)
    encryption = _get_encryption(credentials)

    return AuthOptions(auth_type, encryption, ssl)


def _get_ssl(credentials: Credentials, host: TargetHost) -> bool:
    # Passwordless login only works with SSL false, AUTH_BASIC and ENCRYPTION_NEVER
    if isinstance(credentials.secret, Password):
        if get_plaintext(credentials.secret.password) == "":
            return False

    # Check if default PSRemoting ports are open. Prefer with SSL, if both are.
    if (
        POWERSHELL_SSL_PORT in host.ports_status.tcp_ports
        and host.ports_status.tcp_ports[POWERSHELL_SSL_PORT].status == PortStatus.OPEN
    ):  # Default for HTTPS
        return True

    return False


def _get_auth_type(credentials: Credentials):
    if isinstance(credentials.secret, Password):
        if get_plaintext(credentials.secret.password) == "":
            return AUTH_BASIC

    if isinstance(credentials.secret, LMHash) or isinstance(credentials.secret, NTHash):
        return AUTH_NTLM

    return AUTH_NEGOTIATE


def _get_encryption(credentials: Credentials):
    secret = None
    if isinstance(credentials.secret, Password):
        secret = get_plaintext(credentials.secret.password)
    return ENCRYPTION_NEVER if secret == "" else ENCRYPTION_AUTO
