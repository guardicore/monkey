from typing import Sequence

from common.types import Event
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.propagation_credentials_repository import IPropagationCredentialsRepository

from .smb_exploit_client import SMBExploitClient
from .smb_options import SMBOptions
from .smb_propagation_client import SMBPropagationClient


class SMBExploiter:
    def __init__(
        self,
        exploit_client: SMBExploitClient,
        propagation_client: SMBPropagationClient,
        propagation_credentials_repository: IPropagationCredentialsRepository,
    ):
        self._exploit_client = exploit_client
        self._propagation_client = propagation_client
        self._propagation_credentials_repository = propagation_credentials_repository

    def exploit_host(
        self,
        host: TargetHost,
        servers: Sequence[str],
        current_depth: int,
        options: SMBOptions,
        interrupt: Event,
    ) -> ExploiterResultData:
        if interrupt.is_set():
            return ExploiterResultData()

        credentials = self._propagation_credentials_repository.get_credentials()
        result = self._exploit_client.exploit(host, options, credentials)
        if not result:
            return ExploiterResultData()
        if interrupt.is_set():
            return ExploiterResultData(exploitation_success=result is not None)

        path, propagated_credentials = result
        propagated = self._propagation_client.propagate(
            host, path, propagated_credentials, servers, current_depth, options, interrupt
        )
        return ExploiterResultData(exploitation_success=True, propagation_success=propagated)
