import logging
from typing import Optional, Type

from impacket.dcerpc.v5 import transport
from impacket.dcerpc.v5.rpcrt import DCERPC_v5
from impacket.smbconnection import SMB_DIALECT, SMBConnection

from common.credentials import Credentials, LMHash, NTHash, Password, get_plaintext
from common.types import NetworkPort
from infection_monkey.i_puppet import TargetHost

logger = logging.getLogger(__name__)


def create_smb_connection(host: TargetHost) -> SMBConnection:
    # Create a SMB connection with the credentials
    try:
        return SMBConnection(
            str(host.ip), str(host.ip), sess_port=445, preferredDialect=SMB_DIALECT
        )
    except Exception as err:
        logger.debug(
            f"Failed to create SMB connection to {host} on port 445. Trying port 139: {err}"
        )

        try:
            return SMBConnection("*SMBSEVER", str(host.ip), sess_port=139)
        except Exception as err:
            logger.debug(f"Failed to create SMB connection to {host} on port 139: {err}")
            return None


def smb_login(smb: SMBConnection, credentials: Credentials) -> bool:
    """True if login succeeded, False otherwise"""
    try:
        smb.login(
            user=credentials.identity,
            password=_secret_for_type(credentials, Password),
            domain="",
            lmhash=_secret_for_type(credentials, LMHash),
            nthash=_secret_for_type(credentials, NTHash),
        )
    except Exception as err:
        logger.debug(f"Failed to login to with user {credentials.identity}: {err}")
        return False
    return True


def rpc_connect(host: TargetHost, port: NetworkPort, credentials: Credentials, timeout: int):
    """Connects to the remote host and returns the SMB connection"""
    rpc_transport = transport.DCERPCTransportFactory(f"ncacn_np:{host.ip}[\\pipe\\svcctl]")
    rpc_transport.set_connect_timeout(timeout)
    rpc_transport.set_dport(port)
    rpc_transport.setRemoteHost(str(host.ip))
    rpc_transport.set_credentials(
        username=credentials.identity,
        password=_secret_for_type(credentials, Password),
        domain="",
        lmhash=_secret_for_type(credentials, LMHash),
        nthash=_secret_for_type(credentials, NTHash),
    )
    rpc_transport.set_kerberos(False)

    rpc = dce_rpc_connect(rpc_transport)

    try:
        smb = rpc.get_smb_connection()
        smb.setTimeout(timeout)
        return smb
    except Exception as err:
        logger.debug(f"An error occured while getting SMB connection: {str(err)}")
        return rpc


def dce_rpc_connect(rpc_transport) -> Optional[DCERPC_v5]:
    rpc = rpc_transport.get_dce_rpc()
    try:
        rpc.connect()
        return rpc
    except Exception as err:
        logger.debug(f"Failed to RPC connect to host: {err}")
        return None


def _secret_for_type(credentials: Credentials, secret_type: Type) -> str:
    return get_plaintext(credentials.secret) if type(credentials.secret) == secret_type else ""


def logout_guest(smb: SMBConnection) -> bool:
    if smb.isGuestSession() > 0:
        try:
            smb.logoff()
        except Exception:
            # TODO: If we failed to logout, we should handle that
            pass

            return True
    return False
