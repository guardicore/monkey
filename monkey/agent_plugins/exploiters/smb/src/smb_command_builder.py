import logging
from pathlib import PurePath

from common.command_builder import IAgentCommandBuilder, MonkeyArgs, RunOptions, Shell
from infection_monkey.model import CMD_PREFIX, DROPPER_ARG

logger = logging.getLogger(__name__)


def build_smb_command(
    remote_agent_binary_full_path: PurePath,
    remote_agent_binary_destination_path: PurePath,
    agent_command_builder: IAgentCommandBuilder,
) -> str:
    run_options = RunOptions(
        monkey_args=MonkeyArgs.AGENT,
        agent_destination_path=remote_agent_binary_full_path,
        prefix=CMD_PREFIX,
        shell=Shell.CMD,
    )
    command = agent_command_builder.build_run_command(run_options)
    if (
        str(remote_agent_binary_full_path).lower()
        != str(remote_agent_binary_destination_path).lower()
    ):
        run_options = RunOptions(
            monkey_args=None,
            agent_destination_path=remote_agent_binary_full_path,
            prefix=CMD_PREFIX,
            shell=Shell.CMD,
        )
        command_line_arguments = agent_command_builder.build_agent_command_line_arguments(
            remote_agent_binary_destination_path
        )
        command = (
            f"{agent_command_builder.build_run_command(run_options)} "
            f"{DROPPER_ARG} {command_line_arguments}"
        )

    logger.debug(f"COMMAND: {command}")

    return command
