import logging
from pathlib import PureWindowsPath

from common.command_builder import (
    AgentMode,
    IWindowsAgentCommandBuilder,
    WindowsRunOptions,
    WindowsShell,
)

logger = logging.getLogger(__name__)


def build_smb_command(
    remote_agent_binary_full_path: PureWindowsPath,
    remote_agent_binary_destination_path: PureWindowsPath,
    agent_command_builder: IWindowsAgentCommandBuilder,
) -> str:
    run_options = WindowsRunOptions(
        agent_mode=AgentMode.NONE,
        agent_destination_path=remote_agent_binary_full_path,
        shell=WindowsShell.CMD,
    )
    if (
        str(remote_agent_binary_full_path).lower()
        != str(remote_agent_binary_destination_path).lower()
    ):
        run_options = WindowsRunOptions(
            agent_mode=AgentMode.DROPPER,
            agent_destination_path=remote_agent_binary_full_path,
            shell=WindowsShell.CMD,
            dropper_destination_path=remote_agent_binary_destination_path,
        )

    agent_command_builder.build_run_command(run_options)
    command = agent_command_builder.get_command()

    logger.debug(f"COMMAND: {command}")

    return f"cmd.exe /c {command}"
